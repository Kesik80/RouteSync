<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0d0d14" id="theme-meta"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<link rel="apple-touch-icon" href="/icons/icon-192.png"/>
<link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png"/>
<link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png"/>
<link rel="manifest" href="/icons/manifest.json"/>
<title>RouteSync</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=swap_vert"/>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/latlon-geohash@2.0.0/latlon-geohash.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTESYNC â€” Full Redesign
   Ğ’ÑĞµ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ñ‹ Ñ Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ JS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* FONTS â€” inline fallback ĞµÑĞ»Ğ¸ Ğ¾Ñ„Ğ»Ğ°Ğ¹Ğ½ */
@import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

*,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; }
html { -webkit-tap-highlight-color: transparent; scroll-behavior: smooth; }

/* â”€â”€ Ğ¢ĞĞœĞĞĞ¯ Ğ¢Ğ•ĞœĞ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:           #0d0d14;
  --bg2:          #111119;
  --surface:      #16161f;
  --surface2:     #1c1c28;
  --surface3:     #222230;
  --border:       rgba(255,255,255,0.06);
  --border2:      rgba(255,255,255,0.11);
  --text:         #e8e8f0;
  --text2:        #7878a0;
  --text3:        #454560;
  --accent:       #7c6fff;
  --accent2:      #b09fff;
  --green:        #10d97e;
  --orange:       #ff8040;
  --red:          #ff4560;
  --blue:         #4da6ff;
  --yellow:       #ffd060;

  /* Legacy compat */
  --primary-color:   #7c6fff;
  --success-color:   #10d97e;
  --info-color:      #7878a0;
  --danger-color:    #ff4560;
  --route-back-color:#b09fff;
  --background-color:#0d0d14;
  --surface-color:   #16161f;
  --text-color:      #e8e8f0;
  --border-color:    rgba(255,255,255,0.08);
  --modal-bg:        #16161f;
  --modal-text:      #e8e8f0;

  --r:  11px;
  --r2: 16px;
  --r3: 22px;
  --font: 'Outfit', system-ui, sans-serif;
  --mono: 'JetBrains Mono', 'Courier New', monospace;
  --shadow: 0 8px 32px rgba(0,0,0,0.5);
  --shadow2: 0 2px 12px rgba(0,0,0,0.35);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bot: env(safe-area-inset-bottom, 0px);

  /* legacy spacing */
  --spacing-unit: 10px;
  --small-spacing: 6px;
  --border-radius: var(--r);
  --button-size: 44px;
  --button-font-size: 0.87em;
}

/* â”€â”€ Ğ¡Ğ’Ğ•Ğ¢Ğ›ĞĞ¯ Ğ¢Ğ•ĞœĞ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body:not(.dark) {
  --bg:           #f0eeff;
  --bg2:          #e8e6ff;
  --surface:      #ffffff;
  --surface2:     #f4f2ff;
  --surface3:     #ede9ff;
  --border:       rgba(100,80,220,0.09);
  --border2:      rgba(100,80,220,0.16);
  --text:         #18182e;
  --text2:        #5050780;
  --text3:        #9090b8;
  --accent:       #6655ee;
  --accent2:      #8872f5;
  --green:        #09b865;
  --orange:       #e06020;
  --red:          #e02848;
  --blue:         #2080e0;

  --primary-color:   #6655ee;
  --success-color:   #09b865;
  --info-color:      #505078;
  --danger-color:    #e02848;
  --route-back-color:#8872f5;
  --surface-color:   #ffffff;
  --text-color:      #18182e;
  --border-color:    rgba(100,80,220,0.1);
  --modal-bg:        #ffffff;
  --modal-text:      #18182e;
  --shadow: 0 8px 32px rgba(100,80,220,0.13);
  --shadow2: 0 2px 12px rgba(100,80,220,0.09);
}

/* â”€â”€ BODY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body {
  font-family: var(--font);
  font-size: 15px;
  background: var(--bg);
  color: var(--text);
  max-width: 500px;
  margin: 0 auto;
  padding: calc(var(--safe-top) + 52px) 12px calc(var(--safe-bot) + 16px);
  min-height: 100dvh;
  transition: background .25s, color .25s;
  -webkit-font-smoothing: antialiased;
}

/* noise texture overlay */
body::before {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");
  opacity: .5;
}

main { position: relative; z-index: 1; }

::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

/* â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar {
  position: fixed;
  top: 0; left: 0; right: 0; z-index: 200;
  height: calc(var(--safe-top) + 48px);
  padding: var(--safe-top) 12px 0;
  display: flex; align-items: center; justify-content: space-between;
  background: rgba(13,13,20,0.82);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  transition: background .25s;
}
body:not(.dark) .topbar { background: rgba(240,238,255,0.88); }

.topbar-logo {
  display: flex; align-items: center; gap: 7px;
  font-size: 16px; font-weight: 700; letter-spacing: -.2px;
  color: var(--text);
}
.topbar-logo svg { width: 24px; height: 24px; }

.topbar-right { display: flex; align-items: center; gap: 6px; }

/* â”€â”€ H2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
h2 { display: none; } /* replaced by topbar */

/* â”€â”€ ICON BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.icon-btn {
  width: 34px; height: 34px;
  border-radius: 9px !important;
  background: var(--surface2) !important;
  border: 1px solid var(--border2) !important;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text2) !important;
  font-size: 16px; transition: all .18s;
  padding: 0 !important; box-shadow: none !important;
}
.icon-btn:hover { background: var(--surface3) !important; color: var(--text) !important; transform: none; }
.icon-btn:active { transform: scale(.92) !important; }

/* â”€â”€ THEME TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.theme-toggle {
  position: static !important;
}
.theme-toggle input { display: none; }
.theme-toggle span {
  width: 34px; height: 34px;
  border-radius: 9px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 17px; user-select: none;
  transition: all .18s;
}
.theme-toggle span:hover { background: var(--surface3); }

/* â”€â”€ GOD MODE BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.god-mode {
  position: static !important;
  width: 34px; height: 34px;
  border-radius: 9px !important;
  background: var(--surface2) !important;
  border: 1px solid var(--border2) !important;
  display: flex !important; align-items: center !important; justify-content: center !important;
  cursor: pointer; color: var(--text3) !important;
  padding: 0 !important; box-shadow: none !important;
  opacity: 1 !important;
  transition: all .18s;
}
.god-mode:hover { color: var(--text2) !important; background: var(--surface3) !important; transform: none !important; }

/* â”€â”€ DRIVER CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.driver-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r3);
  padding: 14px 16px;
  margin-bottom: 10px;
  display: flex; align-items: center; gap: 12px;
  box-shadow: var(--shadow2);
  position: relative; overflow: hidden;
}
.driver-card::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(124,111,255,.06), transparent 60%);
  pointer-events: none;
}
.driver-avatar {
  width: 40px; height: 40px; border-radius: 12px; flex-shrink: 0;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-size: 17px; font-weight: 700; color: #fff;
  box-shadow: 0 4px 12px rgba(124,111,255,.3);
  transition: all .3s;
}
.driver-info { flex: 1; min-width: 0; }
.driver-label {
  font-size: 10px; font-weight: 600; color: var(--text3);
  letter-spacing: .6px; text-transform: uppercase; margin-bottom: 3px;
}
#startPoint {
  width: 100%; background: none !important; border: none !important;
  outline: none; font: 600 15px var(--font); color: var(--text) !important;
  cursor: pointer; -webkit-appearance: none; appearance: none;
  padding: 0 !important; border-radius: 0 !important;
}
#startPoint option { background: var(--bg2); color: var(--text); }

/* â”€â”€ ARRIVAL ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.arrival-row {
  display: flex; align-items: center; gap: 8px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r2);
  padding: 11px 14px;
  margin-bottom: 10px;
  box-shadow: var(--shadow2);
}
.arrival-label {
  font-size: 11px; font-weight: 600; color: var(--text3);
  text-transform: uppercase; letter-spacing: .5px; flex-shrink: 0;
}
.arrival-time-input {
  background: none !important; border: none !important;
  font: 700 16px var(--mono); color: var(--accent2) !important;
  cursor: pointer; width: 60px; padding: 0 !important;
  border-radius: 0 !important;
}
.start-point-coords {
  margin-left: auto; flex-shrink: 0;
}

/* â”€â”€ GREETING ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.greeting-container {
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  border-radius: var(--r2) !important;
  padding: 11px 14px !important;
  margin-bottom: 10px !important;
  display: flex !important; align-items: center !important; gap: 8px !important;
  flex-wrap: nowrap !important;
  box-shadow: var(--shadow2) !important;
}
.greeting-container select {
  flex: 1; min-width: 0;
  background: none !important; border: none !important;
  font: 600 14px var(--font); color: var(--text) !important;
  -webkit-appearance: none; cursor: pointer;
  padding: 0 !important; border-radius: 0 !important;
}
.greeting-container select option { background: var(--bg2); }
.greeting-container .edit-greeting-btn,
.greeting-container .start-point-coords {
  width: 30px !important; height: 30px !important;
  background: var(--surface2) !important;
  border: 1px solid var(--border2) !important;
  border-radius: 8px !important;
  display: flex !important; align-items: center !important; justify-content: center !important;
  cursor: pointer !important; flex-shrink: 0 !important;
  color: var(--text2) !important;
  transform: none !important;
  transition: all .18s !important;
  padding: 0 !important; box-shadow: none !important;
  opacity: 1 !important;
}
.greeting-container .edit-greeting-btn:hover,
.greeting-container .start-point-coords:hover {
  background: var(--surface3) !important;
  color: var(--text) !important; transform: none !important;
}
.pencil-icon { fill: var(--text2) !important; width: 15px !important; height: 15px !important; }

/* â”€â”€ SECTION LABEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-label {
  font-size: 10px; font-weight: 700; color: var(--text3);
  letter-spacing: .7px; text-transform: uppercase;
  margin: 14px 2px 7px; display: flex; align-items: center; gap: 8px;
}
.section-label::after {
  content: ''; flex: 1; height: 1px; background: var(--border);
}

/* â”€â”€ PARTICIPANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#participants { display: flex; flex-direction: column; gap: 6px; }

.participant-group { display: flex; flex-direction: column; gap: 3px; }

.participant {
  background: var(--surface) !important;
  border: 1px solid var(--border) !important;
  border-radius: var(--r2) !important;
  padding: 10px 12px !important;
  margin-bottom: 0 !important;
  display: flex !important; align-items: center !important;
  gap: 7px !important; flex-wrap: nowrap !important;
  box-shadow: var(--shadow2) !important;
  transition: border-color .2s, transform .15s !important;
}
.participant:hover { border-color: var(--border2) !important; }
.participant.sortable-ghost { opacity: .4; }
.participant.sortable-drag  { transform: scale(1.02) rotate(.5deg); box-shadow: var(--shadow) !important; }

/* treffpunkt highlight */
.participant.has-treffpunkt {
  border-left: 2px solid var(--orange) !important;
  background: rgba(255,128,64,.035) !important;
}

/* machine */
.participant.machine {
  border: 1px solid rgba(124,111,255,.2) !important;
  background: rgba(124,111,255,.04) !important;
  border-radius: var(--r2) !important;
}

/* â”€â”€ SELECT INSIDE PARTICIPANT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.participant select {
  flex: 1; min-width: 0; max-width: none;
  background: none !important; border: none !important;
  color: var(--text) !important; font: 600 14px var(--font);
  cursor: pointer; -webkit-appearance: none; padding: 0 !important;
  border-radius: 0 !important; outline: none;
}
.participant select option { background: var(--bg2); }

/* machine select */
.participant.machine select { color: var(--accent2) !important; font-weight: 700; }

/* â”€â”€ TIME DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.time-display {
  font: 500 12px var(--mono);
  min-width: 38px; max-width: 50px;
  padding: 4px 7px !important;
  border: 1.5px solid var(--border2) !important;
  border-radius: 8px !important;
  background: var(--surface2) !important;
  color: var(--text2) !important;
  text-align: center; cursor: pointer; user-select: none;
  white-space: nowrap; transition: all .18s;
}
.time-display:hover { border-color: var(--accent) !important; color: var(--text) !important; }
.time-display.auto-calculated {
  border-color: rgba(255,208,96,.4) !important;
  color: var(--yellow) !important;
}
.time-display.route-calculated {
  border-color: rgba(77,166,255,.4) !important;
  color: var(--blue) !important;
  background: rgba(77,166,255,.07) !important;
}
.time-display.editing { display: none !important; }

/* â”€â”€ RIGHT SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.participant .right-section {
  margin-left: auto; display: flex; gap: 4px;
  align-items: center; flex-shrink: 0;
}

/* â”€â”€ DRAG HANDLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.material-symbols-outlined {
  font-size: 20px; cursor: grab; user-select: none;
  color: var(--text3); transition: color .18s;
  line-height: 1;
}
.material-symbols-outlined:hover { color: var(--text2); }
body:not(.dark) .material-symbols-outlined { color: #9090b8; }
body:not(.dark) .material-symbols-outlined:hover { color: #6060a0; }

/* â”€â”€ CALC ROUTE ICON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.calc-route-icon {
  width: 28px; height: 28px;
  border-radius: 8px !important;
  background: var(--surface2) !important;
  border: 1px solid var(--border) !important;
  display: flex !important; align-items: center !important; justify-content: center !important;
  cursor: pointer; padding: 0 !important;
  color: var(--text3) !important; box-shadow: none !important;
  transition: all .18s; flex-shrink: 0;
  overflow: visible !important;
}
.calc-route-icon:hover { border-color: var(--border2) !important; transform: scale(1.08) !important; }
.calc-route-icon.active {
  border-color: rgba(77,166,255,.4) !important;
  background: rgba(77,166,255,.08) !important;
  box-shadow: 0 0 8px rgba(77,166,255,.2) !important;
}

/* â”€â”€ REMOVE BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.participant .remove-btn {
  width: 22px !important; height: 22px !important;
  background: rgba(255,69,96,.1) !important;
  border: 1px solid rgba(255,69,96,.15) !important;
  border-radius: 7px !important; color: var(--red) !important;
  font-size: 12px; display: flex !important;
  align-items: center !important; justify-content: center !important;
  cursor: pointer; flex-shrink: 0;
  transform: translate(4px,-16px) !important;
  opacity: .7; transition: all .18s; padding: 0 !important; box-shadow: none !important;
}
.participant .remove-btn::before { content: "âœ–"; }
.participant .remove-btn:hover {
  opacity: 1; background: rgba(255,69,96,.2) !important;
  transform: translate(4px,-16px) scale(1.1) !important;
}

/* â”€â”€ ADD SUB BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.add-sub-btn {
  width: 22px !important; height: 22px !important;
  border-radius: 50% !important;
  background: rgba(124,111,255,.15) !important;
  border: 1px solid rgba(124,111,255,.2) !important;
  color: var(--accent2) !important;
  font-size: 14px; font-weight: 700;
  display: flex !important; align-items: center !important; justify-content: center !important;
  cursor: pointer; flex-shrink: 0;
  transform: translateY(-4px) !important;
  transition: all .18s; padding: 0 !important; box-shadow: none !important;
}
.add-sub-btn:hover {
  background: rgba(124,111,255,.25) !important;
  transform: translateY(-4px) scale(1.1) !important;
}

/* â”€â”€ SUB PARTICIPANT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sub-participant {
  background: var(--surface2) !important;
  border: 1px solid var(--border) !important;
  border-left: 2px solid var(--accent) !important;
  border-radius: var(--r) !important;
  padding: 6px 11px !important;
  margin-left: 20px !important; margin-top: 2px !important;
  display: flex !important; align-items: center !important; gap: 6px !important;
  box-shadow: none !important;
}
.sub-participant select {
  flex: 1; min-width: 0; max-width: none;
  background: none !important; border: none !important;
  color: var(--text2) !important; font: 500 13px var(--font);
  padding: 0 !important; border-radius: 0 !important;
  cursor: pointer; -webkit-appearance: none;
}
.sub-participant select option { background: var(--bg2); }
.sub-participant .drag-handle-sub {
  cursor: grab; color: var(--text3); font-size: 14px;
  user-select: none; flex-shrink: 0;
}
.sub-participant .remove-sub-btn {
  width: 20px !important; height: 20px !important;
  background: transparent !important; border: none !important;
  color: var(--red) !important; font-size: 12px;
  display: flex !important; align-items: center !important; justify-content: center !important;
  cursor: pointer; flex-shrink: 0; padding: 0 !important;
  opacity: .55; transform: translate(4px,-8px) !important;
  margin-left: auto; transition: all .18s; box-shadow: none !important;
}
.sub-participant .remove-sub-btn::before { content: "âœ–"; }
.sub-participant .remove-sub-btn:hover {
  opacity: 1; transform: translate(4px,-8px) scale(1.2) !important;
  background: transparent !important;
}

/* â”€â”€ BUTTONS SECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.buttons-section {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr;
  gap: 7px;
  margin: 14px 0 10px;
}

button {
  font-family: var(--font);
  font-weight: 600;
  font-size: var(--button-font-size);
  height: var(--button-size);
  border: none; border-radius: var(--r2);
  color: white; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  gap: 6px; transition: all .18s;
  letter-spacing: .05px; white-space: nowrap;
  padding: 0 12px;
}
button:hover { opacity: .88; transform: translateY(-1px); }
button:active { transform: scale(.96); opacity: 1; }

button.calculate {
  background: linear-gradient(135deg, var(--accent), #6655d0);
  box-shadow: 0 4px 16px rgba(124,111,255,.3);
}
button.copy {
  background: linear-gradient(135deg, var(--green), #09a860);
  box-shadow: 0 4px 16px rgba(16,217,126,.22);
}
button.add {
  background: var(--surface2); color: var(--text2);
  border: 1px solid var(--border2) !important;
  box-shadow: none;
}
button.add:hover { background: var(--surface3); color: var(--text); }
button.clear {
  background: rgba(255,69,96,.1); color: var(--red);
  border: 1px solid rgba(255,69,96,.15) !important;
  box-shadow: none;
}
button.clear:hover { background: rgba(255,69,96,.18); }
button.route-back {
  background: linear-gradient(135deg, var(--accent2), #9988ee);
  box-shadow: 0 4px 16px rgba(176,159,255,.22);
}

/* â”€â”€ OUTPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#output {
  font-family: var(--mono) !important;
  font-size: 13px !important; line-height: 1.75 !important;
  background: var(--surface) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
  border-radius: var(--r2) !important;
  padding: 14px 16px !important;
  margin: 10px 0 !important;
  white-space: pre-wrap;
  box-shadow: var(--shadow2);
  min-height: 50px;
}
#output sup { font-size: .68em; vertical-align: super; }

/* â”€â”€ INPUTS GLOBAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
input, select {
  font-family: var(--font);
  background: var(--surface) !important;
  color: var(--text) !important;
  border: 1px solid var(--border2) !important;
  border-radius: var(--r) !important;
  outline: none; transition: border-color .2s;
}
input:focus, select:focus { border-color: var(--accent) !important; }
select { cursor: pointer; }
select option { background: var(--bg2); }

/* â”€â”€ CHECKBOXES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.checkbox-container {
  display: flex; gap: 8px; margin-top: 8px;
  justify-content: flex-end; align-items: center; flex-wrap: wrap;
}
.checkbox-container label {
  display: flex; align-items: center; gap: 5px;
  font-size: 0.82em; color: var(--text2); cursor: pointer;
}
.checkbox-container input[type=checkbox] {
  width: 15px; height: 15px; accent-color: var(--accent);
  border-radius: 4px !important; cursor: pointer;
}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast, .toast {
  position: fixed !important;
  top: calc(var(--safe-top) + 58px) !important;
  left: 50% !important; transform: translateX(-50%) translateY(-16px) !important;
  background: var(--surface2) !important;
  border: 1px solid var(--border2) !important;
  color: var(--text) !important;
  padding: 9px 20px !important; border-radius: 50px !important;
  font: 500 13px var(--font) !important;
  box-shadow: var(--shadow) !important; z-index: 9999 !important;
  white-space: nowrap; pointer-events: none;
  opacity: 0; transition: all .25s !important;
  display: block !important;
}
#toast.show, .toast.show {
  opacity: 1 !important;
  transform: translateX(-50%) translateY(0) !important;
}

/* â”€â”€ ADD TYPE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.add-type-modal {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  z-index: 10000; align-items: flex-end; justify-content: center;
}
.add-type-modal.show { display: flex; }
.add-type-modal-content {
  width: 100%; max-width: 500px;
  background: var(--bg2) !important;
  border: 1px solid var(--border);
  border-radius: var(--r3) var(--r3) 0 0;
  padding: 6px 18px calc(28px + var(--safe-bot));
  box-shadow: 0 -10px 40px rgba(0,0,0,.5);
  animation: rsSlideUp .32s cubic-bezier(.34,1.26,.64,1) both;
}
.add-type-modal-content::before {
  content: ''; display: block; width: 34px; height: 4px;
  background: var(--border2); border-radius: 2px;
  margin: 10px auto 18px;
}
.add-type-modal-title {
  font-size: 1.05em; font-weight: 700; color: var(--text);
  text-align: center; margin-bottom: 16px;
}
.add-type-section { margin-bottom: 12px; }
.add-type-section-label {
  font-size: 10px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: .6px; margin-bottom: 5px;
}
.add-type-select {
  width: 100%; padding: 11px 13px;
  border: 1px solid var(--border2) !important;
  border-radius: var(--r) !important;
  background: var(--surface) !important;
  color: var(--text) !important; font-size: .95em;
  font-family: var(--font);
}
.add-type-buttons { display: flex; gap: 8px; margin-top: 14px; }
.add-type-btn {
  flex: 1; padding: 12px; border: none;
  border-radius: var(--r2); font: 600 .93em var(--font); cursor: pointer;
  transition: all .18s;
}
.add-type-btn.primary { background: var(--accent); color: #fff; }
.add-type-btn.primary:hover { background: #8880ff; }
.add-type-btn.secondary {
  background: var(--surface2); color: var(--text2);
  border: 1px solid var(--border2);
}
.add-type-btn.secondary:hover { background: var(--surface3); color: var(--text); }
.new-name-row { margin-top: 7px; }
.new-name-input {
  width: 100%; padding: 10px 12px;
  border: 1px solid var(--border2) !important;
  border-radius: var(--r) !important;
  background: var(--surface) !important;
  color: var(--text) !important; font-size: .93em; font-family: var(--font);
}
.new-name-hint { font-size: .75em; color: var(--text3); display: block; margin-top: 4px; }

/* â”€â”€ SUB MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sub-modal {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  z-index: 10000; align-items: flex-end; justify-content: center;
}
.sub-modal.show { display: flex; }
.sub-modal-content {
  width: 100%; max-width: 500px;
  background: var(--bg2) !important;
  border: 1px solid var(--border);
  border-radius: var(--r3) var(--r3) 0 0;
  padding: 6px 18px calc(28px + var(--safe-bot));
  box-shadow: 0 -10px 40px rgba(0,0,0,.5);
  animation: rsSlideUp .32s cubic-bezier(.34,1.26,.64,1) both;
}
.sub-modal-content::before {
  content: ''; display: block; width: 34px; height: 4px;
  background: var(--border2); border-radius: 2px; margin: 10px auto 18px;
}
.sub-modal-title {
  font-size: 1.05em; font-weight: 700; color: var(--text); margin-bottom: 12px;
}
.sub-modal-select {
  width: 100%; padding: 11px 13px; margin-bottom: 10px;
  border: 1px solid var(--border2) !important;
  border-radius: var(--r) !important;
  background: var(--surface) !important; color: var(--text) !important;
  font-size: .93em; font-family: var(--font);
}
.sub-modal-buttons { display: flex; gap: 8px; margin-top: 12px; }
.sub-modal-btn {
  flex: 1; padding: 12px; border: none;
  border-radius: var(--r2); font: 600 .93em var(--font); cursor: pointer;
  transition: all .18s;
}
.sub-modal-btn.primary { background: var(--accent); color: #fff; }
.sub-modal-btn.secondary {
  background: var(--surface2); color: var(--text2);
  border: 1px solid var(--border2);
}

/* â”€â”€ GOD MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.god-modal {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.65);
  backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  z-index: 10001; align-items: flex-end; justify-content: center;
}
.god-modal.show { display: flex; }
.god-modal-content {
  width: 100%; max-width: 500px;
  background: var(--bg2) !important;
  border: 1px solid var(--border);
  border-radius: var(--r3) var(--r3) 0 0;
  padding: 6px 18px calc(32px + var(--safe-bot));
  box-shadow: 0 -10px 40px rgba(0,0,0,.6);
  animation: rsSlideUp .32s cubic-bezier(.34,1.26,.64,1) both;
}
.god-modal-content::before {
  content: ''; display: block; width: 34px; height: 4px;
  background: var(--border2); border-radius: 2px; margin: 10px auto 18px;
}
.god-modal-title {
  font-size: 1.05em; font-weight: 700; color: var(--text); margin-bottom: 14px;
}
.god-modal-input {
  width: 100%; padding: 12px 14px; margin-bottom: 12px;
  border: 1px solid var(--border2) !important;
  border-radius: var(--r) !important;
  background: var(--surface) !important; color: var(--text) !important;
  font-size: 1em; letter-spacing: 3px; font-family: var(--font);
}
.god-modal-buttons { display: flex; gap: 8px; }
.god-modal-btn {
  flex: 1; padding: 12px; border: none;
  border-radius: var(--r2); font: 600 .93em var(--font); cursor: pointer;
  transition: all .18s;
}
.god-modal-btn.primary { background: var(--accent); color: #fff; }
.god-modal-btn.secondary {
  background: var(--surface2); color: var(--text2);
  border: 1px solid var(--border2);
}

/* â”€â”€ COORDS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  z-index: 10000; align-items: flex-end; justify-content: center;
}
.modal.show { display: flex; }
.modal-content {
  width: 100% !important; max-width: 500px;
  background: var(--bg2) !important;
  color: var(--text) !important;
  border: 1px solid var(--border) !important;
  border-radius: var(--r3) var(--r3) 0 0 !important;
  padding: 6px 18px calc(28px + var(--safe-bot)) !important;
  box-shadow: 0 -10px 40px rgba(0,0,0,.5) !important;
  animation: rsSlideUp .32s cubic-bezier(.34,1.26,.64,1) both;
  max-height: 88dvh; overflow-y: auto;
  transform: none !important;
}
.modal-content::before {
  content: ''; display: block; width: 34px; height: 4px;
  background: var(--border2); border-radius: 2px; margin: 10px auto 16px;
}
body.dark .modal-content {
  background: var(--bg2) !important;
  color: var(--text) !important;
  border-color: var(--border) !important;
}
.modal-content h3 {
  font-size: 1.05em; font-weight: 700; color: var(--text) !important;
  margin-bottom: 14px;
}
.modal-content label {
  font-size: 10px; font-weight: 700; color: var(--text3) !important;
  text-transform: uppercase; letter-spacing: .5px;
  display: block; margin-bottom: 4px; margin-top: 10px;
}
.modal-content input[type=text] {
  width: 100%; padding: 11px 13px; margin: 0 0 6px;
  border: 1px solid var(--border2) !important;
  border-radius: var(--r) !important;
  background: var(--surface) !important; color: var(--text) !important;
  font-size: .93em; font-family: var(--font); box-sizing: border-box;
}
.modal-content input[type=text]:focus { border-color: var(--accent) !important; }
.modal-content select {
  width: 100%; padding: 11px 13px; margin-bottom: 8px;
  border: 1px solid var(--border2) !important;
  border-radius: var(--r) !important;
  background: var(--surface) !important; color: var(--text) !important;
  font-size: .93em; font-family: var(--font);
}
.modal-buttons {
  display: flex; gap: 8px; justify-content: stretch; margin-top: 12px;
}
.modal-content button, .modal-btn {
  flex: 1; max-width: none; padding: 11px !important; margin: 0 !important;
  border-radius: var(--r2) !important;
  font: 600 .9em var(--font) !important; cursor: pointer;
  color: #fff !important; border: none !important;
  transition: all .18s; height: auto !important;
  transform: none !important;
}
.modal-content button:hover, .modal-btn:hover { opacity: .88; transform: none !important; }
.modal-btn.save-button,    .modal-content .save-button   { background: var(--green) !important; }
.modal-btn.cancel-button,  .modal-content .cancel-button { background: var(--surface3) !important; color: var(--text2) !important; border: 1px solid var(--border2) !important; }
.modal-btn.map-button,     .modal-content .map-button    { background: var(--accent) !important; }
.modal-btn.delete-greeting-btn { background: var(--red) !important; }

/* map btns row */
#mapBtnsRow {
  display: none; gap: 8px;
  justify-content: center; margin-top: 6px; margin-bottom: 4px;
}
#mapBtnsRow.show { display: flex; }
#mapBtnsRow .map-button,
#mapBtnsRow .modal-btn {
  width: 42px !important; height: 38px !important; min-width: 0 !important;
  padding: 0 !important; margin: 0 !important; flex: none !important;
  font-size: 17px !important; border-radius: var(--r) !important;
}
#mapBtnsRow #openMap {
  background: var(--surface2) !important; color: var(--text2) !important;
  border: 1px solid var(--border2) !important;
}
#mapBtnsRow #cancelCoords {
  background: rgba(255,69,96,.12) !important; color: var(--red) !important;
  border: 1px solid rgba(255,69,96,.2) !important;
  font-size: 18px !important;
}
#coordsHelp {
  font-size: .78em !important; color: var(--orange) !important;
  font-weight: 500 !important; margin: 4px 0 !important;
}

/* delete greeting row */
#coordsModal .modal-buttons + div {
  display: flex; justify-content: center; margin-top: 8px;
}

/* â”€â”€ MAP PICKER MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#mapPickerModal .modal-content {
  max-width: 95vw !important; width: 600px !important;
  padding: 0 !important;
  border-radius: var(--r2) !important;
  overflow: hidden;
}
#mapPickerModal .modal-content::before { display: none; }

/* add-new-name variant */
.modal-content.add-new-name {
  background: var(--bg2) !important;
  padding: 6px 18px calc(28px + var(--safe-bot)) !important;
  transform: none !important; box-shadow: 0 -10px 40px rgba(0,0,0,.5) !important;
}
.modal-content.add-new-name h3, .modal-content.add-new-name label { color: var(--text) !important; }

/* â”€â”€ ANIMATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes rsSlideUp {
  from { transform: translateY(100%); opacity: 0; }
  to   { transform: translateY(0);    opacity: 1; }
}
@keyframes rsFadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}
.participant { animation: rsFadeIn .25s ease both; }

/* â”€â”€ MOBILE CONSOLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#mobileConsoleWrap {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 8888;
  max-width: 500px; margin: 0 auto;
}
#mobileConsoleWrap button {
  width: 100%; height: 28px !important; font-size: 11px !important;
  border-radius: 0 !important; background: var(--surface2) !important;
  color: var(--text3) !important; border-top: 1px solid var(--border) !important;
  box-shadow: none !important;
}
#mobileConsole {
  background: #000; color: #0f0; font: 11px var(--mono);
  padding: 8px; max-height: 150px; overflow-y: auto;
  display: none;
}

/* â”€â”€ TREFFPUNKT NAME BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.treffpunkt-name {
  font-size: 11px; color: var(--orange); font-weight: 600;
  letter-spacing: .2px; flex-shrink: 0;
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-logo">
    <svg viewBox="0 0 32 32" fill="none">
      <path d="M7 23 L16 7 L25 23" stroke="url(#tg)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="7"  cy="23" r="2.8" fill="#7c6fff"/>
      <circle cx="16" cy="7"  r="2.8" fill="#b09fff"/>
      <circle cx="25" cy="23" r="2.8" fill="#10d97e"/>
      <defs>
        <linearGradient id="tg" x1="7" y1="7" x2="25" y2="23" gradientUnits="userSpaceOnUse">
          <stop stop-color="#7c6fff"/><stop offset="1" stop-color="#10d97e"/>
        </linearGradient>
      </defs>
    </svg>
    RouteSync
  </div>
  <div class="topbar-right">
    <!-- God mode -->
    <a id="godL" title="Ğ ĞµĞ¶Ğ¸Ğ¼ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€Ğ°">
      <button class="god-mode" id="godModeBtn">
        <svg width="18" height="18" viewBox="0 0 374 383" fill="currentColor">
          <g transform="translate(0,383) scale(0.085,-0.085)">
            <path d="M144 3732 c-87 -5 -83 17 -84 -427 l-2 -390 28 -24 28 -23 27 30 28 31 1 338 c0 185 3 339 6 342 3 3 159 6 346 6 l340 0 19 24 c20 25 18 54 -5 79 -9 9 -91 13 -347 15 -184 1 -357 1 -385 -1z"/>
            <path d="M2920 3730 c-57 -4 -66 -8 -79 -32 -12 -20 -13 -31 -4 -51 15 -32 79 -42 194 -32 44 4 181 4 305 0 l224 -7 0 -337 c0 -185 3 -346 6 -358 8 -29 49 -38 80 -18 l24 15 0 394 c0 367 -1 394 -18 409 -16 15 -58 17 -343 19 -178 2 -353 1 -389 -2z"/>
            <path d="M1768 2419 c-43 -16 -49 -87 -8 -109 10 -5 58 -9 106 -9 87 1 129 -4 169 -21 11 -4 42 -16 68 -25 102 -36 253 -163 299 -249 6 -11 14 -23 18 -26 14 -10 68 -136 86 -200 33 -118 23 -379 -23 -595 -8 -38 -17 -81 -19 -95 -12 -63 -68 -263 -95 -340 -70 -193 -70 -195 -60 -223 8 -20 17 -27 38 -27 39 0 49 9 72 62 67 157 146 446 187 683 22 129 27 192 27 325 1 186 -13 257 -76 394 -20 41 -32 78 -29 82 4 4 2 5 -3 1 -11 -6 -72 82 -67 96 1 5 -2 6 -8 2 -5 -3 -10 -2 -10 4 0 12 -69 77 -135 127 -27 21 -53 43 -57 48 -4 6 -8 8 -8 4 0 -4 -30 9 -67 29 -38 20 -68 35 -68 34 0 -4 -59 11 -70 18 -27 15 -230 23 -267 10z"/>
          </g>
        </svg>
      </button>
    </a>
    <!-- Theme toggle -->
    <label class="theme-toggle">
      <input type="checkbox" id="themeSwitch"/>
      <span title="Ğ¢ĞµĞ¼Ğ°">ğŸŒ™</span>
    </label>
  </div>
</div>

<main>
<h2>Fahrzeit Rechner</h2>

<!-- DRIVER CARD -->
<div class="driver-card">
  <div class="driver-avatar" id="driverAvatar">?</div>
  <div class="driver-info">
    <div class="driver-label">Fahrer</div>
    <select id="startPoint">
      <option value="">â€” Fahrer wÃ¤hlen â€”</option>
    </select>
  </div>
</div>

<!-- ARRIVAL ROW -->
<div class="arrival-row">
  <span class="arrival-label">â° Ankunft</span>
  <input class="arrival-time-input" type="time" id="machineArrivalTime" value="07:00"/>
  <button class="start-point-coords icon-btn" title="Koordinaten Startpunkt" style="margin-left:auto;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/>
      <circle cx="12" cy="9" r="2.5"/>
    </svg>
  </button>
</div>

<!-- GREETING ROW -->
<div class="greeting-container">
  <select id="greeting"></select>
  <button class="edit-greeting-btn" title="BegrÃ¼ÃŸung bearbeiten">
    <svg class="pencil-icon" viewBox="0 0 24 24">
      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
    </svg>
  </button>
</div>

<!-- PARTICIPANTS LIST -->
<div class="section-label">Teilnehmer</div>
<div id="participants"></div>

<!-- BUTTONS -->
<div class="buttons-section">
  <button class="add" title="Teilnehmer hinzufÃ¼gen">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/>
    </svg>
  </button>
  <button class="calculate" title="Berechnen">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
    </svg>
  </button>
  <button class="route-back" title="ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚ Ğ½Ğ°Ğ·Ğ°Ğ´">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polygon points="3 11 22 2 13 21 11 13 3 11"/>
    </svg>
  </button>
  <button class="copy" title="Kopieren">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="9" y="9" width="13" height="13" rx="2"/>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
    </svg>
  </button>
</div>

<!-- RESET under buttons -->
<button class="clear" style="width:100%;margin-top:0;" title="ZurÃ¼cksetzen">
  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <polyline points="1 4 1 10 7 10"/>
    <path d="M3.51 15a9 9 0 1 0 .49-3.85"/>
  </svg>
  ZurÃ¼cksetzen
</button>

<!-- OUTPUT -->
<div class="section-label" style="margin-top:14px;">Nachricht</div>
<pre id="output"></pre>

<!-- CHECKBOXES -->
<div class="checkbox-container">
  <label>
    <input type="checkbox" id="uhrBeiCheck"/>
    â€um â€¦ Uhr bei"
  </label>
  <label>
    <input type="checkbox" id="superscriptCheck"/>
    07Â³â°
  </label>
</div>

<div id="toast" class="toast"></div>

<!-- â•â•â• ADD TYPE MODAL â•â•â• -->
<div id="addTypeModal" class="add-type-modal">
  <div class="add-type-modal-content">
    <div class="add-type-modal-title">Teilnehmer hinzufÃ¼gen</div>
    <div class="add-type-section">
      <div class="add-type-section-label">ğŸ“ Treffpunkt</div>
      <select id="treffpunktSelect" class="add-type-select">
        <option value="">â€“ Treffpunkt wÃ¤hlen â€“</option>
      </select>
    </div>
    <div class="add-type-section">
      <div class="add-type-section-label">ğŸ‘¤ Kollege</div>
      <select id="kollegeSelect" class="add-type-select">
        <option value="">â€“ Kollege wÃ¤hlen â€“</option>
      </select>
      <div class="new-name-row" id="newKollegeRow">
        <input type="text" id="newKollegeName" class="new-name-input" placeholder="Neuer Name eingebenâ€¦" autocomplete="off"/>
        <span class="new-name-hint">Name wird gespeichert und zur Liste hinzugefÃ¼gt</span>
      </div>
    </div>
    <div class="add-type-buttons">
      <button class="add-type-btn secondary" id="addTypeCancelBtn">Abbrechen</button>
      <button class="add-type-btn primary" id="addTypeConfirmBtn">HinzufÃ¼gen</button>
    </div>
  </div>
</div>

<!-- â•â•â• SUB PARTICIPANT MODAL â•â•â• -->
<div id="subModal" class="sub-modal">
  <div class="sub-modal-content">
    <div class="sub-modal-title">Mitfahrer hinzufÃ¼gen</div>
    <select id="subParticipantSelect" class="sub-modal-select">
      <option value="">Teilnehmer wÃ¤hlen</option>
    </select>
    <div class="new-name-row" id="newSubNameRow">
      <input type="text" id="newSubName" class="new-name-input" placeholder="Neuer Name eingebenâ€¦" autocomplete="off"/>
      <span class="new-name-hint">Name wird gespeichert und zur Liste hinzugefÃ¼gt</span>
    </div>
    <div class="sub-modal-buttons">
      <button class="sub-modal-btn secondary" id="subCancelBtn">Abbrechen</button>
      <button class="sub-modal-btn primary" id="subAddBtn">HinzufÃ¼gen</button>
    </div>
  </div>
</div>

<!-- â•â•â• GOD MODE MODAL â•â•â• -->
<div id="godModal" class="god-modal">
  <div class="god-modal-content">
    <div class="god-modal-title">ğŸ” Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¾Ñ€</div>
    <input type="password" id="godPasswordInput" class="god-modal-input" placeholder="Passwort" autocomplete="off"/>
    <div class="god-modal-buttons">
      <button class="god-modal-btn secondary" id="godCancelBtn">Abbrechen</button>
      <button class="god-modal-btn primary" id="godSubmitBtn">Einloggen</button>
    </div>
  </div>
</div>

<!-- â•â•â• COORDS MODAL â•â•â• -->
<div id="coordsModal" class="modal">
  <div class="modal-content" id="modalContent">
    <h3 id="modalTitle">Koordinaten bearbeiten</h3>
    <label id="nameLabel" style="display:none">Name:</label>
    <input type="text" id="nameInput" style="display:none" placeholder="Name eingeben"/>
    <label id="greetingLabel" style="display:none">BegrÃ¼ÃŸung:</label>
    <input type="text" id="greetingInput" style="display:none" placeholder="BegrÃ¼ÃŸung eingeben"/>
    <label id="coordsLabel" style="display:none">Koordinaten / Google Maps Link:</label>
    <input type="text" id="coordsInput" style="display:none" placeholder="51.452013,7.021455 oder https://maps.app.goo.gl/..."/>
    <p id="coordsHelp" style="display:none">âš ï¸ VerkÃ¼rzte Links werden einige Sekunden verarbeitet.</p>
    <select id="stationSelect" style="display:none; margin-top:6px; width:100%; padding:var(--small-spacing);">
      <option value="">â€“ Aus Liste wÃ¤hlen â€“</option>
    </select>
    <div id="mapBtnsRow" style="display:none; gap:8px; justify-content:center; margin-top:14px; margin-bottom:4px;">
      <button class="map-button modal-btn" id="openMap" title="Karte Ã¶ffnen">
        <svg width="20" height="20" viewBox="0 0 90 90" fill="currentColor">
          <path d="M89 79.382H1c-.355 0-.683-.188-.863-.494-.179-.306-.183-.685-.01-.994L15.174 49.373c.177-.315.511-.512.873-.512h22.326c.552 0 1 .447 1 1s-.448 1-1 1H17.534L2.705 77.382h84.59L72.466 50.86H50.728c-.553 0-1-.447-1-1s.447-1 1-1h22.325c.362 0 .696.196.873.512l15.947 28.521c.173.31.169.688-.011.994s-.778.484-1.132.484z"/>
          <path d="M45 60.554L30.514 43.493C27.603 40.063 26 35.701 26 31.213c0-10.477 8.523-19 19-19s19 8.523 19 19c0 4.489-1.603 8.851-4.514 12.28L45 60.554z"/>
        </svg>
      </button>
      <button class="map-button modal-btn" id="openMapPicker" title="Punkt auf Karte wÃ¤hlen">
        <svg width="20" height="20" viewBox="0 0 469 512.42" fill="currentColor">
          <path fill-rule="nonzero" d="M191.82 93.36c27.85 0 53.07 11.31 71.31 29.54 18.23 18.23 29.53 43.46 29.53 71.3 0 27.85-11.3 53.07-29.53 71.31-18.24 18.23-43.46 29.53-71.31 29.53-27.84 0-53.07-11.3-71.3-29.53-18.23-18.24-29.54-43.46-29.54-71.31 0-27.84 11.31-53.07 29.54-71.3 18.23-18.23 43.46-29.54 71.3-29.54z"/>
        </svg>
      </button>
      <button class="modal-btn save-button"   id="saveCoords"   title="Speichern">âœ”</button>
      <button class="modal-btn cancel-button" id="cancelCoords" title="Abbrechen">âœ•</button>
    </div>
    <div style="display:flex;justify-content:center;margin-top:8px;">
      <button class="modal-btn delete-greeting-btn" id="deleteGreeting" title="LÃ¶schen" style="display:none;">ğŸ—‘ LÃ¶schen</button>
    </div>
    <div class="modal-buttons" id="modalButtons"></div>
  </div>
</div>

<!-- â•â•â• MAP PICKER MODAL â•â•â• -->
<div id="mapPickerModal" class="modal" style="display:none; align-items:center; justify-content:center;">
  <div id="mapPickerSheet" class="modal-content" style="max-width:95vw;width:600px;padding:0!important;border-radius:var(--r2)!important;overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--accent);color:#fff;">
      <span style="font-weight:600;font-size:.95em;">ğŸ“ Punkt auf Karte wÃ¤hlen</span>
      <div style="display:flex;gap:6px;align-items:center;">
        <button id="mapFullscreenBtn" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:6px;padding:5px 9px;cursor:pointer;font-size:14px;height:auto!important;">â›¶</button>
        <button id="mapPickerClose" style="background:none;border:none;color:#fff;font-size:20px;cursor:pointer;line-height:1;padding:0 2px;height:auto!important;">âœ•</button>
      </div>
    </div>
    <div id="mapPickerContainer" style="width:100%;height:55vh;min-height:300px;"></div>
    <div style="padding:8px 12px;display:flex;flex-wrap:wrap;gap:6px;align-items:center;background:var(--bg2);border-top:1px solid var(--border);">
      <button id="mapTypeRoad" style="border:1px solid var(--border2);background:var(--surface);color:var(--text);border-radius:6px;padding:5px 10px;cursor:pointer;font-size:12px;font-weight:600;height:auto!important;">ğŸ—º Karte</button>
      <button id="mapTypeSat"  style="border:1px solid var(--border2);background:var(--surface);color:var(--text);border-radius:6px;padding:5px 10px;cursor:pointer;font-size:12px;font-weight:600;height:auto!important;">ğŸ›° Satellit</button>
      <button id="mapGeoBtn"   style="border:1px solid var(--border2);background:var(--surface);color:var(--text);border-radius:6px;padding:5px 10px;cursor:pointer;font-size:12px;height:auto!important;">ğŸ“¡ Mein Ort</button>
      <span id="mapPickerCoords" style="flex:1;font-size:.78em;font-family:var(--mono);color:var(--text3);text-align:right;min-width:120px;">â€”</span>
    </div>
    <div style="padding:8px 12px;display:flex;gap:8px;justify-content:flex-end;background:var(--bg2);border-top:1px solid var(--border);">
      <button id="mapPickerCancel"  class="modal-btn cancel-button" style="flex:none;padding:8px 16px!important;">Abbrechen</button>
      <button id="mapPickerConfirm" class="modal-btn save-button"   style="flex:none;padding:8px 16px!important;" disabled>OK</button>
    </div>
  </div>
</div>

</main>

<script>
// â”€â”€ DRIVER AVATAR UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ĞŸĞ°Ñ‚Ñ‡: Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€ Ğ¿Ñ€Ğ¸ ÑĞ¼ĞµĞ½Ğµ Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ
document.addEventListener('DOMContentLoaded', () => {
  const sel = document.getElementById('startPoint');
  const av  = document.getElementById('driverAvatar');
  if (sel && av) {
    const update = () => {
      const v = sel.value;
      av.textContent = v ? v.charAt(0).toUpperCase() : '?';
    };
    sel.addEventListener('change', update);
    // observe mutations for when options are added by JS
    new MutationObserver(update).observe(sel, { childList: true, subtree: true });
  }
  // Sync arrival time display label
  const arrInput = document.getElementById('machineArrivalTime');
  if (arrInput) {
    arrInput.addEventListener('change', () => {
      if (window._app) { window._app.machineStop.arrivalTime = arrInput.value; window._app.calculate(); }
    });
  }
});
</script>
<script>
"use strict";
class FahrzeitRechner {
constructor() {
this.defaultGreetings = ['Moin zusammen', 'Hallo zusammen', 'Guten Morgen', 'Guten Tag'];
this.greetings = [...this.defaultGreetings];
this.greeting = 'Moin zusammen';
// Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ğ¸Ğ· stations.js â€” ÑĞ¼. Ğ¼ĞµÑ‚Ğ¾Ğ´ loadStations()
const defaultCoords = {};
this.stations        = {};
this.travelTimes     = {};
this.treffpunkt      = {};
this.trefftravelTimes = {};
this.participantOrders = {};
this.startPoint = '';
this.startPointCoords = { lat: null, lng: null };
this.defaultCoordinates = defaultCoords;      // Ğ´Ğ»Ñ ÑĞ±Ñ€Ğ¾ÑĞ°
this.nameToCoordinates = { ...defaultCoords };
this.participants = [];
this.machineStop = { name: "an der Maschine", time: 20, arrivalTime: "", lat: null, lng: null, autoCalculated: false };
this.machineDestinations = [
  { name: 'an der Maschine', lat: null, lng: null },
  { name: 'im BÃ¼ro Bochum', lat: 51.503883, lng: 7.240038 }
];
this.useUhrBei = false;
this.useSuperscriptTime = false;
this.sortable = null;
this.elements = {
greetingSelect: document.getElementById('greeting'),
editGreetingButton: document.querySelector('.edit-greeting-btn'),
startPointSelect: document.getElementById('startPoint'),
startPointCoordsButton: document.querySelector('.start-point-coords'),
participantsContainer: document.getElementById('participants'),
addButton: document.querySelector('.add'),
calculateButton: document.querySelector('.calculate'),
routeBackButton: document.querySelector('.route-back'),
copyButton: document.querySelector('.copy'),
clearButton: document.querySelector('.clear'),
output: document.getElementById('output'),
toast: document.getElementById('toast'),
coordsModal: document.getElementById('coordsModal'),
modalContent: document.querySelector('.modal-content'),
coordsInput: document.getElementById('coordsInput'),
coordsLabel: document.getElementById('coordsLabel'),
coordsHelp: document.getElementById('coordsHelp'),
nameInput: document.getElementById('nameInput'),
nameLabel: document.getElementById('nameLabel'),
greetingInput: document.getElementById('greetingInput'),
greetingLabel: document.getElementById('greetingLabel'),
modalTitle: document.getElementById('modalTitle'),
saveCoordsButton: document.getElementById('saveCoords'),
deleteGreetingButton: document.getElementById('deleteGreeting'),
cancelCoordsButton: document.getElementById('cancelCoords'),
openMapButton: document.getElementById('openMap'),
openMapPickerButton: document.getElementById('openMapPicker'),
mapBtnsRow: document.getElementById('mapBtnsRow')
};
this.currentEditIndex = null;
this.currentMainParticipantIndex = null;
this.currentSubParticipantIndex = null;
this.isEditingMachine = false;
this.isAddingNewName = false;
this.isAddingSubName = false;
this.isAddingNewGreeting = false;
this.isEditingGreeting = false;
this.isEditingStartPoint = false;
this.isAddingNewDestination = false;
this.isAddingNewKollege = false;
this.isAddingNewSubPerson = false;
this.isAddingNewTreffpunkt = false;
this.loadData();
this.syncCoordinates();
this.addEventListeners();
this.renderParticipants();
this.initSortable();
this.elements.output.innerHTML = '';
}
async loadStations() {
try {
  const resp = await fetch('stations.js', { cache: 'no-cache' });
  if (!resp.ok) throw new Error('HTTP ' + resp.status);
  const text = await resp.text();
  // ĞŸĞ°Ñ€ÑĞ¸Ğ¼ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ñ‡ĞµÑ€ĞµĞ· Function()
  const defM  = text.match(/const\s+defaultCoords\s*=\s*({[\s\S]*?});/);
  const stM   = text.match(/this\.stations\s*=\s*({[\s\S]*?});/);
  const tmM   = text.match(/this\.travelTimes\s*=\s*({[\s\S]*?});/);
  // Ğ‘Ğ»Ğ¾ĞºĞ¸ Ñ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ {} â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº ÑĞºĞ¾Ğ±Ğ¾Ğº
  function extractBlock(str, keyword) {
    const idx = str.indexOf(keyword);
    if (idx === -1) return null;
    const start = str.indexOf('{', idx);
    if (start === -1) return null;
    let depth = 0;
    for (let i = start; i < str.length; i++) {
      if (str[i] === '{') depth++;
      else if (str[i] === '}') { depth--; if (depth === 0) return str.slice(start, i + 1); }
    }
    return null;
  }
  const trfBlock = extractBlock(text, 'this.treffpunkt');
  const trtBlock = extractBlock(text, 'this.trefftravelTimes');
  const ordBlock = extractBlock(text, 'this.participantOrders');
  if (defM)  {
    const coords = Function('"use strict";return (' + defM[1] + ')')();
    this.defaultCoordinates = coords;
    this.nameToCoordinates  = { ...coords };
  }
  if (stM)  this.stations          = Function('"use strict";return (' + stM[1]  + ')')();
  if (tmM)  this.travelTimes       = Function('"use strict";return (' + tmM[1]  + ')')();
  if (trfBlock) this.treffpunkt        = Function('"use strict";return (' + trfBlock + ')')();
  if (trtBlock) this.trefftravelTimes  = Function('"use strict";return (' + trtBlock + ')')();
  if (ordBlock) this.participantOrders = Function('"use strict";return (' + ordBlock + ')')();
  // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ğ¸Ğ· Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… stations
  this.syncCoordinates();
  // Ğ•ÑĞ»Ğ¸ Ñƒ Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ Ğ½ĞµÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ° â€” Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¸Ğ· participantOrders
  if (this.startPoint && this.participants.length === 0) {
    this.updateStartPoint(this.startPoint);
  }
  this.updateParticipantTimes();
  this.renderParticipants();
  this.initSortable();
  this.calculate();
} catch (e) {
  console.warn('stations.js Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½:', e.message);
  this.showToast('âš ï¸ stations.js Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ â€” Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹');
}
}
formatMinutes(minutes) {
if (minutes < 60) {
return `${minutes}`;
}
const hours = Math.floor(minutes / 60);
const mins = minutes % 60;
return `${hours}.${mins.toString().padStart(2, '0')}`;
}
getTravelTime(fromName, toName) {
if (fromName === toName) return 0;
const key = `${fromName}-${toName}`;
const rev = `${toName}-${fromName}`;
// Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ñ‰ĞµĞ¼ Ğ² Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… travelTimes
if (this.travelTimes[key] !== undefined) return this.travelTimes[key];
if (this.travelTimes[rev] !== undefined) return this.travelTimes[rev];
// Ğ—Ğ°Ñ‚ĞµĞ¼ Ğ² trefftravelTimes
if (this.trefftravelTimes[key] !== undefined) return this.trefftravelTimes[key];
if (this.trefftravelTimes[rev] !== undefined) return this.trefftravelTimes[rev];
return 5; // fallback
}
updateParticipantTimes() {
let previousPoint = this.startPoint;
this.participants.forEach(participant => {
if (participant.name && !participant.timeManuallyEdited) {
participant.time = this.getTravelTime(previousPoint, participant.name);
}
if (participant.name) previousPoint = participant.name;
});
}
syncCoordinates() {
this.participants.forEach(p => {
const coords = this.nameToCoordinates[p.name];
if (coords) { p.lat = coords.lat; p.lng = coords.lng; }
});
const startCoords = this.nameToCoordinates[this.startPoint];
this.startPointCoords = startCoords ? { lat: startCoords.lat, lng: startCoords.lng } : { lat: null, lng: null };
}
profileKey(key) {
const p = this.startPoint || '';
return p ? `fahrzeitRechner_${p}_${key}` : `fahrzeitRechner${key.charAt(0).toUpperCase() + key.slice(1)}`;
}
saveData() {
const k = (key) => this.profileKey(key);
if (this.startPoint) localStorage.setItem('fahrzeitLastDriver', this.startPoint);
localStorage.setItem(k('greeting'), this.greeting);
localStorage.setItem(k('greetings'), JSON.stringify(this.greetings));
localStorage.setItem(k('participants'), JSON.stringify(this.participants));
localStorage.setItem(k('machineStop'), JSON.stringify(this.machineStop));
localStorage.setItem(k('machineDestinations'), JSON.stringify(this.machineDestinations));
localStorage.setItem(k('nameToCoordinates'), JSON.stringify(this.nameToCoordinates));
localStorage.setItem(k('startPoint'), this.startPoint);
localStorage.setItem(k('useUhrBei'), this.useUhrBei);
localStorage.setItem(k('useSuperscript'), this.useSuperscriptTime);
}
resetToDefaults() {
this.greeting = 'Moin zusammen';
this.greetings = [...this.defaultGreetings];
this.startPoint = '';
this.startPointCoords = { lat: null, lng: null };
this.participants = [];
this.nameToCoordinates = { ...this.defaultCoordinates };
this.machineStop = { name: "an der Maschine", time: 20, arrivalTime: "", lat: null, lng: null };
this.machineDestinations = [
  { name: 'an der Maschine', lat: null, lng: null },
  { name: 'im BÃ¼ro Bochum', lat: 51.503883, lng: 7.240038 }
];
this.useUhrBei = false;
this.useSuperscriptTime = false;
this.saveData();
}
clearLocalStorage() {
['greeting','greetings','participants','machineStop','machineDestinations',
'nameToCoordinates','startPoint','useUhrBei','useSuperscript']
.forEach(k => localStorage.removeItem(this.profileKey(k)));
this.showToast("Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½Ñ‹.");
this.resetToDefaults();
this.elements.output.innerHTML = '';
this.renderParticipants();
this.initSortable();
}
loadData() {
try {
// Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ profileKey Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾
const lastDriver = localStorage.getItem('fahrzeitLastDriver') || '';
if (lastDriver) this.startPoint = lastDriver;

const k = (key) => this.profileKey(key);
const saved = {
greeting: localStorage.getItem(k('greeting')),
greetings: localStorage.getItem(k('greetings')),
participants: localStorage.getItem(k('participants')),
machineStop: localStorage.getItem(k('machineStop')),
machineDestinations: localStorage.getItem(k('machineDestinations')),
nameToCoordinates: localStorage.getItem(k('nameToCoordinates')),
startPoint: localStorage.getItem(k('startPoint')),
useUhrBei: localStorage.getItem(k('useUhrBei')),
useSuperscript: localStorage.getItem(k('useSuperscript'))
};
if (saved.greeting) this.greeting = saved.greeting;
if (saved.greetings) try { this.greetings = JSON.parse(saved.greetings); } catch { this.greetings = [...this.defaultGreetings]; }
if (saved.participants) try { this.participants = JSON.parse(saved.participants).map(p => ({ ...p, timeManuallyEdited: p.timeManuallyEdited || false, subParticipants: p.subParticipants || [], isTreffpunkt: p.isTreffpunkt || false, treffpunktPersons: p.treffpunktPersons || [] })); } catch { this.participants = []; }
if (saved.machineStop) try { this.machineStop = JSON.parse(saved.machineStop); } catch { this.machineStop = { name: "an der Maschine", time: 20, arrivalTime: "", lat: null, lng: null };
this.machineDestinations = [
  { name: 'an der Maschine', lat: null, lng: null },
  { name: 'im BÃ¼ro Bochum', lat: 51.503883, lng: 7.240038 }
]; }
if (saved.machineDestinations) try {
  const parsed = JSON.parse(saved.machineDestinations);
  // ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ (Ğ¼Ğ°ÑÑĞ¸Ğ² ÑÑ‚Ñ€Ğ¾Ğº) Ğ² Ğ½Ğ¾Ğ²Ñ‹Ğ¹ (Ğ¼Ğ°ÑÑĞ¸Ğ² Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ¾Ğ²)
  this.machineDestinations = parsed.map(d =>
    typeof d === 'string' ? { name: d, lat: null, lng: null } : d
  );
} catch { /* use default */ }
if (saved.nameToCoordinates) try { this.nameToCoordinates = JSON.parse(saved.nameToCoordinates); } catch { /* use default */ }
if (saved.startPoint) {
this.startPoint = saved.startPoint;
const startCoords = this.nameToCoordinates[this.startPoint];
this.startPointCoords = startCoords ? { lat: startCoords.lat, lng: startCoords.lng } : { lat: null, lng: null };
}
if (saved.useUhrBei !== null) this.useUhrBei = saved.useUhrBei === 'true';
if (saved.useSuperscript !== null) this.useSuperscriptTime = saved.useSuperscript === 'true';
} catch {
this.resetToDefaults();
}
// ĞĞ• Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ updateStartPoint â€” Ğ¾Ğ½ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑˆĞµÑ‚ participants Ğ¸Ğ· participantOrders
// ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ¸Ğ· nameToCoordinates
this.syncCoordinates();
}
addEventListeners() {
this.elements.greetingSelect.addEventListener('change', e => {
if (e.target.value === 'add-new-greeting') this.openGreetingModal(true);
else { this.greeting = e.target.value; this.saveData(); this.calculate(); }
});
this.elements.editGreetingButton.addEventListener('click', () => this.openGreetingModal(false));
this.elements.startPointSelect.addEventListener('change', e => this.updateStartPoint(e.target.value));
this.elements.startPointCoordsButton.addEventListener('click', () => this.openCoordsModal(null, false, false, true));
this.elements.addButton.addEventListener('click', () => this.addParticipant());
this.elements.calculateButton.addEventListener('click', () => this.openGoogleMaps());
this.elements.routeBackButton.addEventListener('click', () => this.openGoogleMaps(true));
this.elements.copyButton.addEventListener('click', () => this.copyResult());
this.elements.clearButton.addEventListener('click', () => this.clearLocalStorage());
this.elements.saveCoordsButton.addEventListener('click', () => this.saveCoordinates());
this.elements.deleteGreetingButton.addEventListener('click', () => this.deleteGreeting());
this.elements.cancelCoordsButton.addEventListener('click', () => this.closeModal());
this.elements.openMapButton.addEventListener('click', () => this.openMapForSelection());
this.elements.openMapPickerButton.addEventListener('click', () => this.openMapPicker());
// Add-type modal handlers
const addTypeModal = document.getElementById('addTypeModal');
const addTypeCancelBtn = document.getElementById('addTypeCancelBtn');
const addTypeConfirmBtn = document.getElementById('addTypeConfirmBtn');
const closeAddTypeModal = () => {
addTypeModal.classList.remove('show');
const row = document.getElementById('newKollegeRow');
const inp = document.getElementById('newKollegeName');
if (row) row.classList.remove('visible');
if (inp) inp.value = '';
};
if (addTypeModal && addTypeCancelBtn && addTypeConfirmBtn) {
addTypeCancelBtn.addEventListener('click', closeAddTypeModal);
addTypeConfirmBtn.addEventListener('click', () => {
this.addParticipantFromModal();
});
addTypeModal.addEventListener('click', (e) => {
if (e.target === addTypeModal) closeAddTypeModal();
});
document.addEventListener('keydown', (e) => {
if (e.key === 'Escape' && addTypeModal.classList.contains('show')) closeAddTypeModal();
});
}
// Sub-participant modal handlers
const subModal = document.getElementById('subModal');
const subCancelBtn = document.getElementById('subCancelBtn');
const subAddBtn = document.getElementById('subAddBtn');
const closeSubModal = () => {
subModal.classList.remove('show');
const row = document.getElementById('newSubNameRow');
const inp = document.getElementById('newSubName');
if (row) row.classList.remove('visible');
if (inp) inp.value = '';
const sel = document.getElementById('subParticipantSelect');
if (sel) sel.value = '';
};
if (subModal && subCancelBtn && subAddBtn) {
subCancelBtn.addEventListener('click', closeSubModal);
subAddBtn.addEventListener('click', () => {
this.addSubParticipant();
});
subModal.addEventListener('click', (e) => {
if (e.target === subModal) closeSubModal();
});
document.addEventListener('keydown', (e) => {
if (e.key === 'Escape' && subModal.classList.contains('show')) closeSubModal();
});
}
// --- Ğ£Ğ”ĞĞ›Ğ•ĞĞ« ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ Ğ”Ğ›Ğ¯ open-map-direct Ğ¸ open-map-return ---
}
updateStartPoint(value) {
if (value === 'add-new') {
this.openCoordsModal(null, false, true, true);
} else {
this.startPoint = value;
const startCoords = this.nameToCoordinates[value];
this.startPointCoords = startCoords ? { lat: startCoords.lat, lng: startCoords.lng } : { lat: null, lng: null };
const order = this.participantOrders[value] || [];
// Ğ¡Ñ‚Ñ€Ğ¾Ğ¸Ğ¼ Ğ¿Ğ»Ğ¾ÑĞºĞ¸Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ¼Ñ‘Ğ½ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
const flatNames = order.map(item => {
  if (typeof item === 'string') return item;
  if (item?.treffpunkt) return item.treffpunkt;
  return item.main;
});
this.participants = order.map((item, idx) => {
const prev = idx === 0 ? this.startPoint : flatNames[idx - 1];
// Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ Treffpunkt â€” Ğ¼ĞµÑÑ‚Ğ¾ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸ Ñ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ÑÑ‰Ğ¸Ğ¼Ğ¸
if (item?.treffpunkt) {
  const treffName = item.treffpunkt;
  const coords = this.treffpunkt[treffName] || { lat: null, lng: null };
  const treffTime = this.trefftravelTimes?.[`${treffName}-${value}`] ?? this.getTravelTime(prev, treffName);
  return {
    name: treffName,
    time: treffTime,
    lat: coords.lat,
    lng: coords.lng,
    timeManuallyEdited: false,
    isTreffpunkt: true,
    subParticipants: [],
    treffpunktPersons: item.persons || []
  };
}
// ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº Ğ¸Ğ»Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°
const name = typeof item === 'string' ? item : item.main;
const subs = item?.subParticipants || [];
const coords = this.nameToCoordinates[name] || { lat: null, lng: null };
return {
name,
time: this.getTravelTime(prev, name),
lat: coords.lat,
lng: coords.lng,
timeManuallyEdited: false,
isTreffpunkt: false,
subParticipants: subs,
treffpunktPersons: []
};
});
this.updateParticipantTimes();
this.saveData();
this.renderParticipants();
this.initSortable();
this.calculate();
}
}
// Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Set Ğ²ÑĞµÑ… Ğ·Ğ°Ğ½ÑÑ‚Ñ‹Ñ… Ğ¸Ğ¼Ñ‘Ğ½ (Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ optionalExclude)
getAllUsedNames(optionalExclude = null) {
  const used = new Set();
  if (this.startPoint) used.add(this.startPoint);
  this.participants.forEach(p => {
    if (p.name && p.name !== optionalExclude) used.add(p.name);
    (p.subParticipants || []).forEach(n => { if (n !== optionalExclude) used.add(n); });
    (p.treffpunktPersons || []).forEach(n => { if (n !== optionalExclude) used.add(n); });
  });
  return used;
}
renderParticipants() {
const container = this.elements.participantsContainer;
container.innerHTML = '';
this.elements.greetingSelect.innerHTML = this.greetings.map(g => `<option value="${g}" ${this.greeting === g ? 'selected' : ''}>${g}</option>`).join('') + '<option value="add-new-greeting">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ</option>';
const nameOptions = Object.keys(this.nameToCoordinates).map(name => `<option value="${name}" ${this.startPoint === name ? 'selected' : ''}>${name}</option>`).join('');
this.elements.startPointSelect.innerHTML = `
<option value="" ${!this.startPoint ? 'selected' : ''}>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½ÑƒÑ Ñ‚Ğ¾Ñ‡ĞºÑƒ</option>
${nameOptions}
<option value="add-new">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¸Ğ¼Ñ</option>
`;
const noCoordsSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="rgb(209,43,47)"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
const hasCoordsSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="rgb(68,178,229)"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
const coloredMapSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 92.3 132.3" width="24" height="24"><path fill="#1a73e8" d="M60.2 2.2C55.8.8 51 0 46.1 0 32 0 19.3 6.4 10.8 16.5l21.8 18.3L60.2 2.2z"/><path fill="#ea4335" d="M10.8 16.5C4.1 24.5 0 34.9 0 46.1c0 8.7 1.7 15.7 4.6 22l28-33.3-21.8-18.3z"/><path fill="#4285f4" d="M46.2 28.5c9.8 0 17.7 7.9 17.7 17.7 0 4.3-1.6 8.3-4.2 11.4 0 0 13.9-16.6 27.5-32.7-5.6-10.8-15.3-19-27-22.7L32.6 34.8c3.3-3.8 8.1-6.3 13.6-6.3"/><path fill="#fbbc04" d="M46.2 63.8c-9.8 0-17.7-7.9-17.7-17.7 0-4.3 1.5-8.3 4.1-11.3l-28 33.3c4.8 10.6 12.8 19.2 21 29.9l34.1-40.5c-3.3 3.9-8.1 6.3-13.5 6.3"/><path fill="#34a853" d="M59.1 109.2c15.4-24.1 33.3-35 33.3-63 0-7.7-1.9-14.9-5.2-21.3L25.6 98c2.6 3.4 5.3 7.3 7.9 11.3 9.4 14.5 6.8 23.1 12.8 23.1s3.4-8.7 12.8-23.2"/></svg>`;
const grayMapSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 92.3 132.3" width="24" height="24"><path fill="#999" d="M60.2 2.2C55.8.8 51 0 46.1 0 32 0 19.3 6.4 10.8 16.5l21.8 18.3L60.2 2.2z"/><path fill="#999" d="M10.8 16.5C4.1 24.5 0 34.9 0 46.1c0 8.7 1.7 15.7 4.6 22l28-33.3-21.8-18.3z"/><path fill="#999" d="M46.2 28.5c9.8 0 17.7 7.9 17.7 17.7 0 4.3-1.6 8.3-4.2 11.4 0 0 13.9-16.6 27.5-32.7-5.6-10.8-15.3-19-27-22.7L32.6 34.8c3.3-3.8 8.1-6.3 13.6-6.3"/><path fill="#999" d="M46.2 63.8c-9.8 0-17.7-7.9-17.7-17.7 0-4.3 1.5-8.3 4.1-11.3l-28 33.3c4.8 10.6 12.8 19.2 21 29.9l34.1-40.5c-3.3 3.9-8.1 6.3-13.5 6.3"/><path fill="#999" d="M59.1 109.2c15.4-24.1 33.3-35 33.3-63 0-7.7-1.9-14.9-5.2-21.3L25.6 98c2.6 3.4 5.3 7.3 7.9 11.3 9.4 14.5 6.8 23.1 12.8 23.1s3.4-8.7 12.8-23.2"/></svg>`;
this.elements.startPointCoordsButton.innerHTML = (this.startPointCoords.lat && this.startPointCoords.lng) ? hasCoordsSvg : noCoordsSvg;
const validNames = this.participants.map(p => p.name).filter(n => n);
if (this.startPoint && validNames.includes(this.startPoint)) {
this.showToast(`ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ° "${this.startPoint}" Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°Ñ‚ÑŒ Ñ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°.`);
this.startPoint = ''; this.startPointCoords = { lat: null, lng: null };
this.participants = []; this.saveData();
}
this.participants.forEach((p, i) => {
// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ Ğ´Ğ»Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° Ğ¸ ĞµĞ³Ğ¾ ÑÑƒĞ±ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
const groupDiv = document.createElement('div');
groupDiv.className = 'participant-group';
groupDiv.setAttribute('data-index', i);
// ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº
const div = document.createElement('div');
div.className = 'participant main-participant' + (p.isTreffpunkt ? ' has-treffpunkt' : '');
div.setAttribute('data-index', i);

if (p.isTreffpunkt) {
// ===== Ğ ĞµĞ½Ğ´ĞµÑ€ Treffpunkt-ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° =====
const coordsSvg = (p.lat && p.lng) ? hasCoordsSvg : noCoordsSvg;
div.innerHTML = `
<select data-index="${i}" data-type="participant-name" aria-label="Treffpunkt">
<option value="${p.name}" selected>ğŸ“ ${p.name}</option>
${Object.keys(this.treffpunkt).filter(n => n !== p.name).map(n => `<option value="${n}">ğŸ“ ${n}</option>`).join('')}
</select>
<button class="coords-icon" data-index="${i}" data-type="participant-coords" aria-label="Redaktieren">${coordsSvg}</button>
<div class="time-display" data-index="${i}" data-type="participant-time-display" title="ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ">
${this.formatMinutes(p.time)}
</div>
<button class="add-sub-btn" data-index="${i}" title="Person hinzufÃ¼gen" style="background:#28a745;">+</button>
<div class="right-section">
<span class="material-symbols-outlined" aria-label="ĞŸĞµÑ€ĞµĞ¼ĞµÑÑ‚Ğ¸Ñ‚ÑŒ">
<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M320-440v-287L217-624l-57-56 200-200 200 200-57 56-103-103v287h-80ZM600-80 400-280l57-56 103 103v-287h80v287l103-103 57 56L600-80Z"/></svg>
</span>
<button class="remove-btn" data-index="${i}" aria-label="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"></button>
</div>
`;
groupDiv.appendChild(div);

// ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ»ÑĞ´ĞµĞ¹ Ğ½Ğ° Treffpunkt ĞºĞ°Ğº ÑÑƒĞ±ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
if (p.treffpunktPersons && p.treffpunktPersons.length > 0) {
p.treffpunktPersons.forEach((personName, personIdx) => {
const subDiv = document.createElement('div');
subDiv.className = 'sub-participant';
subDiv.setAttribute('data-main-index', i);
subDiv.setAttribute('data-sub-index', personIdx);

const usedInTreff = this.getAllUsedNames(personName);
const personOptions = Object.keys(this.nameToCoordinates)
.filter(n => !usedInTreff.has(n) || n === personName)
.sort()
.map(n => `<option value="${n}" ${n === personName ? 'selected' : ''}>${n}</option>`)
.join('');

subDiv.innerHTML = `
<span class="drag-handle-sub">â‹®â‹®</span>
<select data-main-index="${i}" data-sub-index="${personIdx}" data-type="treff-person-name" aria-label="Person am Treffpunkt">
${personOptions}
</select>
<button class="remove-sub-btn" data-main-index="${i}" data-sub-index="${personIdx}" aria-label="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"></button>
`;
groupDiv.appendChild(subDiv);
});
}

} else {
// ===== Ğ ĞµĞ½Ğ´ĞµÑ€ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° (Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´) =====
const usedForMain = this.getAllUsedNames(p.name);
const participantNameOptions = Object.keys(this.nameToCoordinates)
.filter(n => n !== this.startPoint && (!usedForMain.has(n) || n === p.name))
.map(n => `<option value="${n}" ${p.name === n ? 'selected' : ''}>${n}</option>`).join('');
const coordsSvg = (p.lat && p.lng) ? hasCoordsSvg : noCoordsSvg;
const participantCalcIcon = p.routeCalculated ? coloredMapSvg : grayMapSvg;
div.innerHTML = `
<select data-index="${i}" data-type="participant-name" aria-label="Ğ˜Ğ¼Ñ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°">
<option value="" ${!p.name ? 'selected' : ''}>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ</option>
${participantNameOptions}
<option value="add-new">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¸Ğ¼Ñ</option>
</select>
<button class="coords-icon" data-index="${i}" data-type="participant-coords" aria-label="Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°">${coordsSvg}</button>
<div class="time-display ${p.routeCalculated ? 'route-calculated' : ''}" data-index="${i}" data-type="participant-time-display" title="ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ">
${this.formatMinutes(p.time)}
</div>
<button class="calc-route-icon" data-index="${i}" data-type="calc-route-participant" aria-label="Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ğ¿ÑƒÑ‚Ğ¸" title="Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ñ‚ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°">
  ${participantCalcIcon}
</button>
<button class="add-sub-btn" data-index="${i}" title="Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° Ğº Ğ¿Ğ¾ĞµĞ·Ğ´ĞºĞµ">+</button>
<div class="right-section">
<span class="material-symbols-outlined" aria-label="ĞŸĞµÑ€ĞµĞ¼ĞµÑÑ‚Ğ¸Ñ‚ÑŒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°">
<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M320-440v-287L217-624l-57-56 200-200 200 200-57 56-103-103v287h-80ZM600-80 400-280l57-56 103 103v-287h80v287l103-103 57 56L600-80Z"/></svg>
</span>
<button class="remove-btn" data-index="${i}" aria-label="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°"></button>
</div>
`;
groupDiv.appendChild(div);
// Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ (subParticipants)
if (p.subParticipants && p.subParticipants.length > 0) {
p.subParticipants.forEach((subName, subIdx) => {
const subDiv = document.createElement('div');
subDiv.className = 'sub-participant';
subDiv.setAttribute('data-main-index', i);
subDiv.setAttribute('data-sub-index', subIdx);
const usedInSub = this.getAllUsedNames(subName);
const subNameOptions = Object.keys(this.nameToCoordinates)
.filter(n => n !== this.startPoint && (!usedInSub.has(n) || n === subName))
.sort()
.map(n => `<option value="${n}" ${subName === n ? 'selected' : ''}>${n}</option>`).join('');
subDiv.innerHTML = `
<span class="drag-handle-sub">â‹®â‹®</span>
<select data-main-index="${i}" data-sub-index="${subIdx}" data-type="sub-name" aria-label="Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº">
${subNameOptions}
<option value="add-new">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¸Ğ¼Ñ</option>
</select>
<button class="remove-sub-btn" data-main-index="${i}" data-sub-index="${subIdx}" aria-label="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ"></button>
`;
groupDiv.appendChild(subDiv);
});
}
}

container.appendChild(groupDiv);
// Event listeners Ğ´Ğ»Ñ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°
div.querySelector('[data-type="participant-name"]').addEventListener('change', e => {
if (p.isTreffpunkt) this.updateTreffpunktName(i, e.target.value);
else this.updateName(i, e.target.value);
});
const timeDisplay = div.querySelector('[data-type="participant-time-display"]');
if (timeDisplay) {
timeDisplay.addEventListener('click', () => this.editParticipantTime(i, timeDisplay));
}
div.querySelector('[data-type="participant-coords"]').addEventListener('click', () => this.openCoordsModal(i));
const calcRouteBtn = div.querySelector('[data-type="calc-route-participant"]');
if (calcRouteBtn) calcRouteBtn.addEventListener('click', () => this.calculateTravelTimeForParticipant(i));
div.querySelector('.add-sub-btn').addEventListener('click', () => {
if (p.isTreffpunkt) this.openTreffpunktPersonModal(i);
else this.openSubParticipantModal(i);
});
div.querySelector('.remove-btn').addEventListener('click', () => this.removeParticipant(i));
// Event listeners Ğ´Ğ»Ñ ÑÑƒĞ±ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² / treffpunkt persons
groupDiv.querySelectorAll('[data-type="sub-name"]').forEach(select => {
select.addEventListener('change', (e) => {
const mainIdx = parseInt(e.target.dataset.mainIndex);
const subIdx = parseInt(e.target.dataset.subIndex);
if (e.target.value === 'add-new') {
this.currentMainParticipantIndex = mainIdx;
this.currentSubParticipantIndex = subIdx;
this.isAddingSubName = true;
this.openCoordsModal(null, false, true);
} else {
this.updateSubParticipant(mainIdx, subIdx, e.target.value);
}
});
});
groupDiv.querySelectorAll('[data-type="treff-person-name"]').forEach(select => {
select.addEventListener('change', (e) => {
const mainIdx = parseInt(e.target.dataset.mainIndex);
const personIdx = parseInt(e.target.dataset.subIndex);
this.updateTreffpunktPerson(mainIdx, personIdx, e.target.value);
});
});
groupDiv.querySelectorAll('.remove-sub-btn').forEach(btn => {
btn.addEventListener('click', () => {
const mainIdx = parseInt(btn.dataset.mainIndex);
const subIdx = parseInt(btn.dataset.subIndex);
if (this.participants[mainIdx].isTreffpunkt) {
this.removeTreffpunktPerson(mainIdx, subIdx);
} else {
this.removeSubParticipant(mainIdx, subIdx);
}
});
});
});
const machineDiv = document.createElement('div');
machineDiv.className = 'participant machine';
const machineCoordsSvg = (this.machineStop.lat && this.machineStop.lng) ? hasCoordsSvg : noCoordsSvg;
// SVG Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ² Ğ¿ÑƒÑ‚Ğ¸
const calcIcon = this.machineStop.autoCalculated ? coloredMapSvg : grayMapSvg;
// Ğ¡Ñ‚Ñ€Ğ¾Ğ¸Ğ¼ Ğ¾Ğ¿Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ select Ğ¿ÑƒĞ½ĞºÑ‚Ğ° Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
const destOptions = this.machineDestinations.map(d =>
  `<option value="${d.name}" ${this.machineStop.name === d.name ? 'selected' : ''}>${d.name}</option>`
).join('');
const isCustom = !this.machineDestinations.some(d => d.name === this.machineStop.name);
machineDiv.innerHTML = `
<select data-type="machine-name" aria-label="ĞŸÑƒĞ½ĞºÑ‚ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ">
  ${destOptions}
  ${isCustom ? `<option value="${this.machineStop.name}" selected>${this.machineStop.name}</option>` : ''}
  <option value="__add_new__">â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ÑƒĞ½ĞºÑ‚â€¦</option>
</select>
<button class="coords-icon" data-type="machine-coords" aria-label="Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹">${machineCoordsSvg}</button>
<div class="time-display ${this.machineStop.autoCalculated ? 'auto-calculated' : ''}" data-type="machine-time-display" title="ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ">
${this.formatMinutes(this.machineStop.time)}
</div>
<button class="calc-route-icon" data-type="calc-route" aria-label="Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ğ¿ÑƒÑ‚Ğ¸" title="Ğ Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ² Ğ¿ÑƒÑ‚Ğ¸ Ğ¾Ñ‚ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°">
  ${calcIcon}
</button>
<div class="right-section">
${this.machineStop.arrivalTime
? `<div class="arrival-time" tabindex="0" role="button" aria-label="Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ñ‚Ğ¸Ñ">${this.machineStop.arrivalTime}</div><button class="time-remove" aria-label="ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ñ‚Ğ¸Ñ"></button>`
: '<button class="time-icon" aria-label="Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ñ‚Ğ¸Ñ">ğŸ•’</button>'
}
</div>
`;
container.appendChild(machineDiv);
const machineNameSel = machineDiv.querySelector('[data-type="machine-name"]');

machineNameSel.addEventListener('change', e => {
  const val = e.target.value;
  if (val === '__add_new__') {
    // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ select Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ â€” Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ° ÑĞ°Ğ¼Ğ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚
    machineNameSel.value = this.machineStop.name;
    this.openCoordsModal(null, false, false, false, true); // isAddingNewDestination
  } else {
    // ĞŸĞ¾Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
    const dest = this.machineDestinations.find(d => d.name === val);
    if (dest && dest.lat && dest.lng) {
      this.machineStop.lat = dest.lat;
      this.machineStop.lng = dest.lng;
      this.machineStop.autoCalculated = false;
    } else if (dest) {
      this.machineStop.lat = null;
      this.machineStop.lng = null;
    }
    this.updateMachineName(val);
    this.renderParticipants();
  }
});

const machineTimeDisplay = machineDiv.querySelector('[data-type="machine-time-display"]');
if (machineTimeDisplay) {
machineTimeDisplay.addEventListener('click', () => this.editMachineTime(machineTimeDisplay));
}
machineDiv.querySelector('[data-type="machine-coords"]').addEventListener('click', () => this.openCoordsModal(null, true));
machineDiv.querySelector('[data-type="calc-route"]').addEventListener('click', () => this.calculateTravelTimeToMachine());
container.appendChild(machineDiv);
// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ¾Ğ²
const checkboxContainer = document.createElement('div');
checkboxContainer.className = 'checkbox-container';
checkboxContainer.innerHTML = `
<label>
<input type="checkbox" id="useUhrBei" ${this.useUhrBei ? 'checked' : ''}> um...Uhr bei
</label>
<label>
<input type="checkbox" id="useSuperscriptTime" ${this.useSuperscriptTime ? 'checked' : ''}> XÂ²
</label>
<label class="theme-toggle">
`;
container.appendChild(checkboxContainer);
// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ´Ğ»Ñ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ¾Ğ²
const uhrBeiCheckbox = checkboxContainer.querySelector('#useUhrBei');
uhrBeiCheckbox.addEventListener('change', () => {
this.useUhrBei = uhrBeiCheckbox.checked;
this.saveData();
this.calculate();
});
const superscriptCheckbox = checkboxContainer.querySelector('#useSuperscriptTime');
superscriptCheckbox.addEventListener('change', () => {
this.useSuperscriptTime = superscriptCheckbox.checked;
this.saveData();
this.calculate();
});
const timeControl = machineDiv.querySelector('.time-icon') || machineDiv.querySelector('.arrival-time');
timeControl.addEventListener('click', () => this.startTimeEdit());
timeControl.addEventListener('keydown', (e) => {
if (e.key === 'Enter' || e.key === ' ') {
e.preventDefault();
this.startTimeEdit();
}
});
const timeRemoveBtn = machineDiv.querySelector('.time-remove');
if (timeRemoveBtn) timeRemoveBtn.addEventListener('click', () => this.clearArrivalTime());
this.saveData();
if (this.machineStop.arrivalTime) this.calculate(); else this.elements.output.innerHTML = '';
}
async parseCoordinates(raw) {
const s = raw.trim();
if (!s) { this.showToast("ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ."); return null; }
try {
this.showToast("ğŸ”„ ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑÑ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹â€¦");
const resp = await fetch('/api/parse-coords?input=' + encodeURIComponent(s));
const d = await resp.json();
if (d.success) return { lat: d.lat, lng: d.lng };
this.showToast(d.error || "ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ½Ğµ Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ½Ñ‹.");
return null;
} catch(e) {
this.showToast("ĞÑˆĞ¸Ğ±ĞºĞ°: " + e.message);
return null;
}
}
openCoordsModal(index, isMachine = false, isAddingNewName = false, isEditingStartPoint = false, isAddingNewDestination = false, isAddingNewKollege = false, isAddingNewSubPerson = false) {
this.currentEditIndex = index;
this.isEditingMachine = isMachine;
this.isAddingNewName = isAddingNewName;
this.isEditingStartPoint = isEditingStartPoint;
this.isAddingNewDestination = isAddingNewDestination;
this.isAddingNewKollege = isAddingNewKollege;
this.isAddingNewSubPerson = isAddingNewSubPerson;
this.isAddingNewGreeting = false;
this.isEditingGreeting = false;
if (!isAddingNewName) this.isAddingSubName = false;
const modal = this.elements.coordsModal;
const modalContent = this.elements.modalContent;
const coordsInput = this.elements.coordsInput;
const coordsLabel = this.elements.coordsLabel;
const coordsHelp = this.elements.coordsHelp;
const nameInput = this.elements.nameInput;
const nameLabel = this.elements.nameLabel;
const greetingInput = this.elements.greetingInput;
const greetingLabel = this.elements.greetingLabel;
const modalTitle = this.elements.modalTitle;
const openMapButton = this.elements.openMapButton;
const openMapPickerButton = this.elements.openMapPickerButton;
const deleteGreetingButton = this.elements.deleteGreetingButton;
modalContent.classList.toggle('add-new-name', isAddingNewName);
modalTitle.textContent = isAddingNewDestination ? 'ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿ÑƒĞ½ĞºÑ‚ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ' :
isAddingNewKollege ? 'Neuer Kollege' :
isAddingNewSubPerson ? 'Neue Person' :
isAddingNewName ? 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¸Ğ¼Ñ' :
isEditingStartPoint ? 'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ‚Ğ¾Ñ‡ĞºĞ¸' :
isMachine ? 'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹' : 'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹';
[nameLabel, nameInput, greetingLabel, greetingInput, deleteGreetingButton].forEach(el => el.style.display = 'none');
[coordsLabel, coordsHelp, coordsInput, this.elements.mapBtnsRow].forEach(el => el.style.display = 'block');
this.elements.mapBtnsRow.style.display = 'flex';
// Ğ²Ñ‹Ğ±Ğ¾Ñ€ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ğ¹
const stSel = document.getElementById('stationSelect');
if (isMachine) {
stSel.style.display = 'block';
stSel.innerHTML = '<option value="">â€“ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ° â€“</option>' +
Object.entries(this.stations)
.map(([name,c]) => `<option value="${c.lat},${c.lng}">${name}</option>`)
.join('');
/* âœ Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚Ğ¸Ñ‚ÑŒ Ñ€Ğ°Ğ½ĞµĞµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½ÑƒÑ ÑÑ‚Ğ°Ğ½Ñ†Ğ¸Ñ */
const saved = this.machineStop.lat && this.machineStop.lng ? `${this.machineStop.lat},${this.machineStop.lng}` : '';
stSel.value = saved && [...stSel.options].some(o => o.value === saved) ? saved : '';
stSel.onchange = () => {
this.elements.coordsInput.value = stSel.value;
};
} else {
stSel.style.display = 'none';
}
if (isAddingNewDestination || isAddingNewName || isAddingNewKollege || isAddingNewSubPerson) {
nameLabel.style.display = 'block';
nameInput.style.display = 'block';
nameInput.value = '';
coordsInput.value = '';
} else if (isEditingStartPoint) {
coordsInput.value = this.startPointCoords.lat && this.startPointCoords.lng ? `${this.startPointCoords.lat},${this.startPointCoords.lng}` : '';
} else if (isMachine) {
coordsInput.value = this.machineStop.lat && this.machineStop.lng ? `${this.machineStop.lat},${this.machineStop.lng}` : '';
} else {
const participant = this.participants[index];
coordsInput.value = participant.lat && participant.lng ? `${participant.lat},${participant.lng}` : '';
}
modal.style.display = 'flex';
// ĞĞ²Ñ‚Ğ¾Ñ„Ğ¾ĞºÑƒÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸ â€”
// Ğ¸Ğ½Ğ°Ñ‡Ğµ Ğ½Ğ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾Ğ¼ ÑÑ€Ğ°Ğ·Ñƒ Ğ²Ñ‹ÑĞºĞ°ĞºĞ¸Ğ²Ğ°ĞµÑ‚ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ°
if (isAddingNewName) {
nameInput.focus();
}
}
openGreetingModal(isAddingNewGreeting) {
this.isAddingNewGreeting = isAddingNewGreeting;
this.isEditingGreeting = !isAddingNewGreeting;
this.isAddingNewName = false;
this.isEditingMachine = false;
this.isEditingStartPoint = false;
const modal = this.elements.coordsModal;
const modalContent = this.elements.modalContent;
modalContent.classList.remove('add-new-name');
this.elements.modalTitle.textContent = isAddingNewGreeting ? 'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğµ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ' : 'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ';
['coordsLabel', 'coordsHelp', 'coordsInput', 'mapBtnsRow', 'nameLabel', 'nameInput'].forEach(el => this.elements[el].style.display = 'none');
this.elements.greetingLabel.style.display = 'block';
this.elements.greetingInput.style.display = 'block';
this.elements.greetingInput.value = this.greeting;
this.elements.deleteGreetingButton.style.display = this.defaultGreetings.includes(this.greeting) ? 'none' : 'inline-block';
modal.style.display = 'flex';
this.elements.greetingInput.focus();
}
async saveCoordinates() {
const saveButton = this.elements.saveCoordsButton;
try {
if (this.isAddingNewGreeting || this.isEditingGreeting) {
const newGreeting = this.elements.greetingInput.value.trim();
if (!newGreeting) { this.showToast("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ."); return; }
if (this.isAddingNewGreeting && this.greetings.includes(newGreeting)) { this.showToast("ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚."); return; }
if (this.isEditingGreeting) {
const old = this.greeting;
const idx = this.greetings.indexOf(old);
if (idx !== -1 && !this.defaultGreetings.includes(old)) this.greetings[idx] = newGreeting;
this.greeting = newGreeting;
} else if (this.isAddingNewGreeting) {
this.greetings.push(newGreeting);
this.greeting = newGreeting;
}
this.closeModal(); this.saveData(); this.renderParticipants(); this.calculate();
} else {
const raw = this.elements.coordsInput.value.trim();
let coords = null;
if (raw) {                                  // Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ²Ğ²Ñ‘Ğ»
coords = await this.parseCoordinates(raw);
if (!coords) return;                    // Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµĞ¼ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ÑÑ‚ÑŒ
}
// ĞµÑĞ»Ğ¸ raw Ğ¿ÑƒÑÑ‚ â€“ coords Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ null, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ
if (this.isAddingNewKollege || this.isAddingNewSubPerson) {
const name = this.elements.nameInput.value.trim();
if (!name) { this.showToast('âš ï¸ Bitte einen Namen eingeben'); return; }
if (this.nameToCoordinates[name]) { this.showToast(`âš ï¸ "${name}" existiert bereits`); return; }
this.nameToCoordinates[name] = coords ? { lat: coords.lat, lng: coords.lng } : { lat: null, lng: null };
if (this.isAddingNewKollege) {
  this.participants.push({ name, time: 5, lat: coords ? coords.lat : null, lng: coords ? coords.lng : null, timeManuallyEdited: false, isTreffpunkt: false, subParticipants: [], treffpunktPersons: [] });
  document.getElementById('addTypeModal').classList.remove('show');
} else {
  // isAddingNewSubPerson â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğº ÑÑƒĞ±ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° Ğ¸Ğ»Ğ¸ treffpunktPerson
  const mainIndex = this.currentMainParticipantIndex;
  const mainP = this.participants[mainIndex];
  if (mainP.isTreffpunkt) {
    if (!mainP.treffpunktPersons) mainP.treffpunktPersons = [];
    mainP.treffpunktPersons.push(name);
  } else {
    if (!mainP.subParticipants) mainP.subParticipants = [];
    mainP.subParticipants.push(name);
  }
  document.getElementById('subModal').classList.remove('show');
}
this.closeModal(); this.updateParticipantTimes(); this.saveData(); this.renderParticipants(); this.initSortable(); this.calculate();
return;
}
if (this.isAddingNewDestination) {
const name = this.elements.nameInput.value.trim();
if (!name) { this.showToast('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿ÑƒĞ½ĞºÑ‚Ğ°.'); return; }
if (this.machineDestinations.some(d => d.name === name)) { this.showToast('Ğ¢Ğ°ĞºĞ¾Ğ¹ Ğ¿ÑƒĞ½ĞºÑ‚ ÑƒĞ¶Ğµ ĞµÑÑ‚ÑŒ.'); return; }
this.machineDestinations.push({ name, lat: coords ? coords.lat : null, lng: coords ? coords.lng : null });
this.machineStop.name = name;
this.machineStop.lat  = coords ? coords.lat : null;
this.machineStop.lng  = coords ? coords.lng : null;
this.machineStop.autoCalculated = false;
this.closeModal(); this.saveData(); this.renderParticipants(); this.calculate();
return;
}
if (this.isAddingNewTreffpunkt) {
const name = this.elements.nameInput.value.trim();
if (!name) { this.showToast('âš ï¸ Bitte einen Namen eingeben'); return; }
if (this.treffpunkt[name]) { this.showToast(`âš ï¸ "${name}" existiert bereits`); return; }
this.treffpunkt[name] = coords ? { lat: coords.lat, lng: coords.lng } : { lat: null, lng: null };
// Ğ¡Ñ€Ğ°Ğ·Ñƒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğº ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°-Treffpunkt
this.participants.push({
  name,
  time: 5,
  lat: coords ? coords.lat : null,
  lng: coords ? coords.lng : null,
  timeManuallyEdited: false,
  isTreffpunkt: true,
  treffpunktPersons: []
});
this.isAddingNewTreffpunkt = false;
this.closeModal(); this.updateParticipantTimes(); this.saveData(); this.renderParticipants(); this.initSortable(); this.calculate();
return;
}
if (this.isAddingNewName) {
const name = this.elements.nameInput.value.trim();
if (!name) { this.showToast("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ."); return; }
if (this.nameToCoordinates[name]) { this.showToast("Ğ˜Ğ¼Ñ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚."); return; }
/* 1. Ğ¡ĞĞ¥Ğ ĞĞĞ¯Ğ•Ğœ Ğ¸Ğ¼Ñ (Ñ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ¸Ğ»Ğ¸ Ğ±ĞµĞ·) */
this.nameToCoordinates[name] = coords
? { lat: coords.lat, lng: coords.lng }
: { lat: null, lng: null };
/* 2. Ğ•ÑĞ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ´Ğ»Ñ ÑÑƒĞ±ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ² subParticipants */
if (this.isAddingSubName) {
const mainIdx = this.currentMainParticipantIndex;
const subIdx = this.currentSubParticipantIndex;
if (subIdx !== null && subIdx !== undefined) {
// Ğ—Ğ°Ğ¼ĞµĞ½Ğ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞ³Ğ¾ ÑÑƒĞ±ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°
this.participants[mainIdx].subParticipants[subIdx] = name;
} else {
// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑÑƒĞ±ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°
if (!this.participants[mainIdx].subParticipants) {
this.participants[mainIdx].subParticipants = [];
}
this.participants[mainIdx].subParticipants.push(name);
}
this.isAddingSubName = false;
this.currentSubParticipantIndex = null;
} else if (this.isEditingStartPoint) {
this.startPoint = name;
this.startPointCoords = { ...this.nameToCoordinates[name] };
this.participants = [];
} else {
const p = this.participants[this.currentEditIndex];
p.name = name;
p.lat  = this.nameToCoordinates[name].lat;
p.lng  = this.nameToCoordinates[name].lng;
p.timeManuallyEdited = false;
}
this.updateParticipantTimes();
}
else if (this.isEditingMachine) {
this.machineStop.lat = coords.lat; this.machineStop.lng = coords.lng;
this.closeModal(); this.saveData(); this.renderParticipants(); this.initSortable();
this.showToast('âœ… Koordinaten gespeichert');
// ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾ÑĞ»Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹
setTimeout(() => this.calculateTravelTimeToMachine(), 500);
return; // Ğ’Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ Ğ½Ğ¸Ğ¶Ğµ
} else if (this.isEditingStartPoint) {
this.startPointCoords = { lat: coords.lat, lng: coords.lng };
this.updateParticipantTimes();
} else {
this.participants[this.currentEditIndex].lat = coords.lat;
this.participants[this.currentEditIndex].lng = coords.lng;
this.participants[this.currentEditIndex].timeManuallyEdited = false;
this.updateParticipantTimes();
}
this.closeModal(); this.saveData(); this.renderParticipants(); this.initSortable(); this.calculate();
this.showToast('âœ… Koordinaten gespeichert');
}
} catch(e) {
  this.showToast('âš ï¸ ' + e.message);
}
}
deleteGreeting() {
if (!this.defaultGreetings.includes(this.greeting)) {
this.greetings = this.greetings.filter(g => g !== this.greeting);
this.greeting = this.defaultGreetings[0];
this.closeModal(); this.saveData(); this.renderParticipants(); this.calculate();
}
}
closeModal() {
this.elements.coordsModal.style.display = 'none';
this.isAddingNewName = this.isEditingMachine = this.isAddingNewGreeting = this.isEditingGreeting = this.isEditingStartPoint = this.isAddingNewDestination = this.isAddingNewKollege = this.isAddingNewSubPerson = this.isAddingNewTreffpunkt = false;
this.isAddingNewKollege = false;
this.isAddingNewSubPerson = false;
this.isAddingNewTreffpunkt = false;
this.currentEditIndex = null;
}
openMapForSelection() {
const coords = this.elements.coordsInput.value.trim();
let url = 'https://www.google.com/maps';
if (coords) {
const m = coords.match(/([-+]?\d{1,3}\.\d+)[,\s]+([-+]?\d{1,3}\.\d+)/);
const parsed = m ? { lat: +m[1], lng: +m[2] } : null;
if (parsed && Math.abs(parsed.lat) <= 90) url += `/place/${parsed.lat},${parsed.lng}`;
else url += `/search/${encodeURIComponent(coords)}`;
}
window.open(url, '_blank');
}

// â”€â”€ Map Picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async openMapPicker() {
  const modal = document.getElementById('mapPickerModal');
  const container = document.getElementById('mapPickerContainer');
  const coordsSpan = document.getElementById('mapPickerCoords');
  const confirmBtn = document.getElementById('mapPickerConfirm');

  modal.style.display = 'flex';
  modal.style.cssText += 'display:flex;align-items:center;justify-content:center;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.6);';

  let pickedLat = null, pickedLng = null;

  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ API ĞºĞ»ÑÑ‡
  let apiKey;
  try {
    const r = await fetch('/api/maps-key');
    const d = await r.json();
    apiKey = d.key;
  } catch(e) {
    this.showToast('âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ API ĞºĞ»ÑÑ‡ ĞºĞ°Ñ€Ñ‚Ñ‹');
    modal.style.display = 'none';
    return;
  }

  // ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ° â€” Ğ¸Ğ· Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ»Ñ Ğ¸Ğ»Ğ¸ Ñ†ĞµĞ½Ñ‚Ñ€ Ğ“ĞµÑ€Ğ¼Ğ°Ğ½Ğ¸Ğ¸
  let initLat = 51.5, initLng = 7.0, initZoom = 10;
  const cur = this.elements.coordsInput.value.trim();
  const m = cur.match(/([-+]?\d{1,3}\.\d+)[,\s]+([-+]?\d{1,3}\.\d+)/);
  if (m) { initLat = +m[1]; initLng = +m[2]; initZoom = 15; }

  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Google Maps JS API ĞµÑĞ»Ğ¸ ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½
  const initMap = () => {
    const map = new google.maps.Map(container, {
      center: { lat: initLat, lng: initLng },
      zoom: initZoom,
      mapTypeId: 'roadmap',
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
    });

    // â”€â”€ ĞŸĞ¾Ğ»Ğ½Ğ¾ÑĞºÑ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const sheet = document.getElementById('mapPickerSheet');
    let isFullscreen = false;
    document.getElementById('mapFullscreenBtn').onclick = () => {
      isFullscreen = !isFullscreen;
      if (isFullscreen) {
        sheet.style.cssText = 'position:fixed;inset:0;width:100vw;max-width:100vw;height:100dvh;border-radius:0;padding:0;display:flex;flex-direction:column;';
        container.style.height = 'auto';
        container.style.flex = '1';
        document.getElementById('mapFullscreenBtn').textContent = 'âŠ¡';
        document.getElementById('mapFullscreenBtn').title = 'Ğ¡Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ';
      } else {
        sheet.style.cssText = 'max-width:95vw;width:600px;padding:0;background:var(--modal-bg,#fff) !important;border-radius:12px;overflow:hidden;transition:all .2s ease;';
        container.style.height = '55vh';
        container.style.flex = '';
        document.getElementById('mapFullscreenBtn').textContent = 'â›¶';
        document.getElementById('mapFullscreenBtn').title = 'Ğ Ğ°Ğ·Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ½Ğ° Ğ²ĞµÑÑŒ ÑĞºÑ€Ğ°Ğ½';
      }
      google.maps.event.trigger(map, 'resize');
    };

    // â”€â”€ Ğ¡Ğ¼ĞµĞ½Ğ° Ñ‚Ğ¸Ğ¿Ğ° ĞºĞ°Ñ€Ñ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const btnRoad = document.getElementById('mapTypeRoad');
    const btnSat  = document.getElementById('mapTypeSat');
    const setActive = (active, inactive) => {
      active.style.cssText   = 'border:2px solid var(--primary-color,#1976d2);background:#e8f0fe;border-radius:6px;padding:5px 10px;cursor:pointer;font-size:12px;font-weight:700;color:var(--primary-color,#1976d2);';
      inactive.style.cssText = 'border:1px solid #ccc;background:#fff;border-radius:6px;padding:5px 10px;cursor:pointer;font-size:12px;font-weight:600;color:#333;';
    };
    setActive(btnRoad, btnSat);
    btnRoad.onclick = () => { map.setMapTypeId('roadmap');   setActive(btnRoad, btnSat); };
    btnSat.onclick  = () => { map.setMapTypeId('satellite'); setActive(btnSat, btnRoad); };

    // â”€â”€ Ğ“ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let geoMarker = null;
    document.getElementById('mapGeoBtn').onclick = () => {
      if (!navigator.geolocation) { alert('Ğ“ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ'); return; }
      const btn = document.getElementById('mapGeoBtn');
      btn.textContent = 'â³ â€¦';
      navigator.geolocation.getCurrentPosition(
        pos => {
          btn.textContent = 'ğŸ“¡ ĞœĞ¾Ñ‘ Ğ¼ĞµÑÑ‚Ğ¾';
          const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          map.panTo(loc); map.setZoom(16);
          if (geoMarker) geoMarker.setPosition(loc);
          else geoMarker = new google.maps.Marker({
            position: loc, map,
            icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: '#4285F4', fillOpacity: 1, strokeColor: '#fff', strokeWeight: 2 },
            title: 'ĞœĞ¾Ñ‘ Ğ¼ĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ', zIndex: 1
          });
        },
        err => { btn.textContent = 'ğŸ“¡ ĞœĞ¾Ñ‘ Ğ¼ĞµÑÑ‚Ğ¾'; alert('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ: ' + err.message); },
        { enableHighAccuracy: true, timeout: 10000 }
      );
    };

    // â”€â”€ ĞŸĞ¾Ğ¸ÑĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const searchInput = Object.assign(document.createElement('input'), {
      type: 'text', placeholder: 'ğŸ” ĞŸĞ¾Ğ¸ÑĞº Ğ°Ğ´Ñ€ĞµÑĞ°â€¦',
    });
    searchInput.style.cssText = 'margin:8px;padding:7px 12px;width:240px;border:none;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.3);font-size:14px;outline:none;';
    const searchBox = new google.maps.places.SearchBox(searchInput);
    map.controls[google.maps.ControlPosition.TOP_LEFT].push(searchInput);
    searchBox.addListener('places_changed', () => {
      const places = searchBox.getPlaces();
      if (!places?.length) return;
      map.panTo(places[0].geometry.location);
      map.setZoom(16);
    });

    // â”€â”€ ĞœĞ°Ñ€ĞºĞµÑ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let marker = null;
    const coordsSpan = document.getElementById('mapPickerCoords');
    const confirmBtn = document.getElementById('mapPickerConfirm');

    const placeMarker = (latLng) => {
      pickedLat = latLng.lat(); pickedLng = latLng.lng();
      coordsSpan.textContent = `${pickedLat.toFixed(6)}, ${pickedLng.toFixed(6)}`;
      confirmBtn.disabled = false;
      if (marker) marker.setPosition(latLng);
      else {
        marker = new google.maps.Marker({ position: latLng, map, draggable: true, animation: google.maps.Animation.DROP });
        marker.addListener('dragend', e => {
          pickedLat = e.latLng.lat(); pickedLng = e.latLng.lng();
          coordsSpan.textContent = `${pickedLat.toFixed(6)}, ${pickedLng.toFixed(6)}`;
        });
      }
    };

    if (m) placeMarker(new google.maps.LatLng(initLat, initLng));
    map.addListener('click', e => placeMarker(e.latLng));
  };

  if (window.google?.maps) {
    container.innerHTML = '';
    initMap();
  } else {
    container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#888;">â³ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ĞºĞ°Ñ€Ñ‚Ñ‹â€¦</div>';
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=__mapPickerInit`;
    script.async = true;
    window.__mapPickerInit = () => { container.innerHTML = ''; initMap(); };
    document.head.appendChild(script);
  }

  // ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ
  confirmBtn.onclick = () => {
    if (pickedLat === null) return;
    this.elements.coordsInput.value = `${pickedLat.toFixed(6)},${pickedLng.toFixed(6)}`;
    modal.style.display = 'none';
  };

  // Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ
  const close = () => { modal.style.display = 'none'; pickedLat = null; };
  document.getElementById('mapPickerClose').onclick = close;
  document.getElementById('mapPickerCancel').onclick = close;
}
addParticipant() {
this.openAddTypeModal();
}
openAddTypeModal() {
const modal = document.getElementById('addTypeModal');
const treffSelect = document.getElementById('treffpunktSelect');
const kollegeSelect = document.getElementById('kollegeSelect');
const newKollegeRow = document.getElementById('newKollegeRow');
const newKollegeName = document.getElementById('newKollegeName');

// Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Treffpunkt
treffSelect.innerHTML = '<option value="">â€“ Treffpunkt wÃ¤hlen â€“</option>';
Object.keys(this.treffpunkt).forEach(name => {
const opt = document.createElement('option');
opt.value = name;
opt.textContent = name;
treffSelect.appendChild(opt);
});
const newTreffOpt = document.createElement('option');
newTreffOpt.value = 'add-new-treff';
newTreffOpt.textContent = 'â• Neuer Treffpunktâ€¦';
treffSelect.appendChild(newTreffOpt);

// Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ»Ğ»ĞµĞ³
kollegeSelect.innerHTML = '<option value="">â€“ Kollege wÃ¤hlen â€“</option>';
Object.keys(this.nameToCoordinates)
.filter(name => !this.getAllUsedNames().has(name) && !this.treffpunkt[name])
.sort()
.forEach(name => {
const opt = document.createElement('option');
opt.value = name;
opt.textContent = name;
kollegeSelect.appendChild(opt);
});
// ĞĞ¿Ñ†Ğ¸Ñ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
const newOpt = document.createElement('option');
newOpt.value = 'add-new';
newOpt.textContent = 'â• Neuer Kollegeâ€¦';
kollegeSelect.appendChild(newOpt);

// Ğ¡Ğ±Ñ€Ğ¾Ñ
treffSelect.value = '';
kollegeSelect.value = '';
newKollegeRow.classList.remove('visible');
newKollegeName.value = '';

// Ğ’Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ + Ğ¿Ğ¾ĞºĞ°Ğ· Ğ¿Ğ¾Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
treffSelect.onchange = () => {
if (treffSelect.value === 'add-new-treff') {
  treffSelect.value = '';
  document.getElementById('addTypeModal').classList.remove('show');
  // ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚ ĞºĞ°Ğº "Neuer Treffpunkt" â€” Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ isAddingNewName
  // Ğ½Ğ¾ Ñ Ğ¿Ğ¾Ğ¼ĞµÑ‚ĞºĞ¾Ğ¹ Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ Ğ´Ğ»Ñ treffpunkt
  this.isAddingNewTreffpunkt = true;
  this.openCoordsModal(null, false, true); // isAddingNewName=true Ğ¾Ñ‚ĞºÑ€Ğ¾ĞµÑ‚ Ğ¿Ğ¾Ğ»Ñ Ğ¸Ğ¼ĞµĞ½Ğ¸+ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚
  // ĞŸĞ¾Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ¿Ğ¾ÑĞ»Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ
  setTimeout(() => { const t = document.getElementById('modalTitle'); if (t) t.textContent = 'Neuer Treffpunkt'; }, 10);
} else if (treffSelect.value) {
  kollegeSelect.value = '';
  newKollegeRow.classList.remove('visible');
}
};
kollegeSelect.onchange = () => {
if (kollegeSelect.value) treffSelect.value = '';
if (kollegeSelect.value === 'add-new') {
kollegeSelect.value = '';
document.getElementById('addTypeModal').classList.remove('show');
this.openCoordsModal(null, false, false, false, false, true); // isAddingNewKollege
} else {
newKollegeRow.classList.remove('visible');
newKollegeName.value = '';
}
};

modal.classList.add('show');
}
addParticipantFromModal() {
const treffSelect = document.getElementById('treffpunktSelect');
const kollegeSelect = document.getElementById('kollegeSelect');
const newKollegeName = document.getElementById('newKollegeName');
const treffVal = treffSelect.value;
const kollegeVal = kollegeSelect.value;

if (!treffVal && !kollegeVal) {
this.showToast('âš ï¸ Bitte wÃ¤hlen Sie einen Treffpunkt oder Kollegen');
return;
}

if (treffVal) {
// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğº Treffpunkt-ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°
const coords = this.treffpunkt[treffVal] || { lat: null, lng: null };
this.participants.push({
name: treffVal,
time: 5,
lat: coords.lat,
lng: coords.lng,
timeManuallyEdited: false,
isTreffpunkt: true,
treffpunktPersons: []
});
} else if (kollegeVal === 'add-new') {
// ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ»Ğ»ĞµĞ³Ğ° â€” Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
const newName = newKollegeName.value.trim();
if (!newName) {
this.showToast('âš ï¸ Bitte einen Namen eingeben');
newKollegeName.focus();
return;
}
if (this.nameToCoordinates[newName]) {
this.showToast(`âš ï¸ "${newName}" existiert bereits`);
newKollegeName.focus();
return;
}
// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ² Ñ€ĞµĞµÑÑ‚Ñ€ (Ğ±ĞµĞ· ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚)
this.nameToCoordinates[newName] = { lat: null, lng: null };
this.participants.push({
name: newName,
time: 5,
lat: null,
lng: null,
timeManuallyEdited: false,
isTreffpunkt: false,
subParticipants: [],
treffpunktPersons: []
});
this.showToast(`âœ… "${newName}" hinzugefÃ¼gt`);
} else {
// ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ»Ğ»ĞµĞ³Ğ° Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ°
const coords = this.nameToCoordinates[kollegeVal] || { lat: null, lng: null };
this.participants.push({
name: kollegeVal,
time: 5,
lat: coords.lat,
lng: coords.lng,
timeManuallyEdited: false,
isTreffpunkt: false,
subParticipants: [],
treffpunktPersons: []
});
}

document.getElementById('addTypeModal').classList.remove('show');
this.updateParticipantTimes();
this.saveData();
this.renderParticipants();
this.initSortable();
this.calculate();
}
editParticipantTime(index, displayElement) {
// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ°
const input = document.createElement('input');
input.type = 'text';
const minutes = this.participants[index].time;
const hours = Math.floor(minutes / 60);
const mins = minutes % 60;
input.value = hours > 0 ? `${hours}.${mins.toString().padStart(2, '0')}` : `${minutes}`;
input.placeholder = '3.30';
input.style.width = '55px';
input.style.maxWidth = '55px';
input.style.minWidth = '60px';
input.style.padding = '6px 10px';
input.style.border = '2px solid var(--primary-color)';
input.style.borderRadius = '4px';
input.style.fontSize = '0.95em';
input.style.textAlign = 'center';
input.style.background = 'var(--surface)';
input.style.color = 'var(--text)';

input.style.boxSizing = 'border-box';

// Ğ’ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
displayElement.classList.add('editing');
displayElement.parentNode.insertBefore(input, displayElement);

const saveTime = () => {
const value = input.value.trim();
let totalMinutes = 0;
if (value.includes('.') || value.includes(':')) {
// Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: 3.30 Ğ¸Ğ»Ğ¸ 3:30
const parts = value.split(/[.:]/).map(p => parseInt(p) || 0);
totalMinutes = (parts[0] || 0) * 60 + (parts[1] || 0);
} else {
// ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹: 45
totalMinutes = parseInt(value) || 0;
}
this.participants[index].time = Math.max(1, Math.min(999, totalMinutes));
this.participants[index].timeManuallyEdited = true;
this.participants[index].routeCalculated = false;
input.remove();
displayElement.classList.remove('editing');
this.saveData();
this.renderParticipants();
this.initSortable();
this.calculate();
};

input.addEventListener('blur', saveTime);
input.addEventListener('keypress', (e) => {
if (e.key === 'Enter') saveTime();
});
input.focus();
input.select();
}
editMachineTime(displayElement) {
// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ°
const input = document.createElement('input');
input.type = 'text';
const minutes = this.machineStop.time;
const hours = Math.floor(minutes / 60);
const mins = minutes % 60;
input.value = hours > 0 ? `${hours}.${mins.toString().padStart(2, '0')}` : `${minutes}`;
input.placeholder = '3.30';
input.style.width = '55px';
input.style.maxWidth = '55px';
input.style.minWidth = '60px';
input.style.padding = '6px 6px';
input.style.border = '2px solid var(--primary-color)';
input.style.borderRadius = '4px';
input.style.fontSize = '0.95em';
input.style.textAlign = 'center';
input.style.background = 'var(--surface)';
input.style.color = 'var(--text)';

input.style.boxSizing = 'border-box';

// Ğ’ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
displayElement.classList.add('editing');
displayElement.parentNode.insertBefore(input, displayElement);

const saveTime = () => {
const value = input.value.trim();
let totalMinutes = 0;
if (value.includes('.') || value.includes(':')) {
// Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: 3.30 Ğ¸Ğ»Ğ¸ 3:30
const parts = value.split(/[.:]/).map(p => parseInt(p) || 0);
totalMinutes = (parts[0] || 0) * 60 + (parts[1] || 0);
} else {
// ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹: 45
totalMinutes = parseInt(value) || 0;
}
this.machineStop.time = Math.max(1, Math.min(999, totalMinutes));
this.machineStop.autoCalculated = false;
input.remove();
displayElement.classList.remove('editing');
this.saveData();
this.renderParticipants();
this.calculate();
};

input.addEventListener('blur', saveTime);
input.addEventListener('keypress', (e) => {
if (e.key === 'Enter') saveTime();
});
input.focus();
input.select();
}
updateName(index, value) {
if (value === 'add-new') this.openCoordsModal(index, false, true);
else {
this.participants[index].name = value;
const coords = this.nameToCoordinates[value] || { lat: null, lng: null };
this.participants[index].lat = coords.lat;
this.participants[index].lng = coords.lng;
this.participants[index].timeManuallyEdited = false;
this.participants[index].routeCalculated = false;
this.updateParticipantTimes();
this.saveData();
this.renderParticipants();
this.initSortable();
this.calculate();
}
}
updateTime(index, value) {
const time = parseInt(value) || 5;
this.participants[index].time = Math.max(1, Math.min(120, time));
this.participants[index].timeManuallyEdited = true;
this.participants[index].routeCalculated = false;
this.saveData();
this.renderParticipants();
this.calculate();
}
openSubParticipantModal(mainIndex) {
this.currentMainParticipantIndex = mainIndex;
const modal = document.getElementById('subModal');
const select = document.getElementById('subParticipantSelect');
const newSubNameRow = document.getElementById('newSubNameRow');
const newSubNameInput = document.getElementById('newSubName');
const mainParticipant = this.participants[mainIndex];

// Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
newSubNameRow.classList.remove('visible');
newSubNameInput.value = '';

// Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ·Ğ°Ğ½ÑÑ‚Ñ‹Ğµ Ğ¸Ğ¼ĞµĞ½Ğ°
const usedNames = this.getAllUsedNames();

select.innerHTML = '<option value="">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°</option>';
Object.keys(this.nameToCoordinates)
.filter(name => !usedNames.has(name))
.sort()
.forEach(name => {
const option = document.createElement('option');
option.value = name;
option.textContent = name;
select.appendChild(option);
});
// ĞĞ¿Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
const newOpt = document.createElement('option');
newOpt.value = 'add-new';
newOpt.textContent = 'â• Neue Personâ€¦';
select.appendChild(newOpt);

// ĞŸĞ¾ĞºĞ°Ğ·/ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ°
select.onchange = () => {
if (select.value === 'add-new') {
select.value = '';
document.getElementById('subModal').classList.remove('show');
this.openCoordsModal(null, false, false, false, false, false, true); // isAddingNewSubPerson
} else {
newSubNameRow.classList.remove('visible');
newSubNameInput.value = '';
}
};

modal.classList.add('show');
setTimeout(() => select.focus(), 100);
}
addSubParticipant() {
// Ğ•ÑĞ»Ğ¸ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº â€” Treffpunkt, Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ°Ğº treffpunktPerson
const mainIndex = this.currentMainParticipantIndex;
if (mainIndex !== null && this.participants[mainIndex] && this.participants[mainIndex].isTreffpunkt) {
this.addTreffpunktPerson();
return;
}
const select = document.getElementById('subParticipantSelect');
const newSubNameInput = document.getElementById('newSubName');
let selectedName = select.value;

if (!selectedName) {
this.showToast('âš ï¸ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°');
return;
}

// ĞĞ¾Ğ²Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ¾ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
if (selectedName === 'add-new') {
const newName = newSubNameInput.value.trim();
if (!newName) {
this.showToast('âš ï¸ Bitte einen Namen eingeben');
newSubNameInput.focus();
return;
}
if (this.nameToCoordinates[newName]) {
this.showToast(`âš ï¸ "${newName}" existiert bereits`);
newSubNameInput.focus();
return;
}
this.nameToCoordinates[newName] = { lat: null, lng: null };
selectedName = newName;
}

if (!this.participants[mainIndex].subParticipants) {
this.participants[mainIndex].subParticipants = [];
}
this.participants[mainIndex].subParticipants.push(selectedName);
document.getElementById('subModal').classList.remove('show');
this.saveData();
this.renderParticipants();
this.initSortable();
this.calculate();
this.showToast(`âœ… ${selectedName} Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½`);
}
removeSubParticipant(mainIndex, subIndex) {
const removedName = this.participants[mainIndex].subParticipants[subIndex];
this.participants[mainIndex].subParticipants.splice(subIndex, 1);
this.saveData();
this.renderParticipants();
this.initSortable();
this.calculate();
this.showToast(`ğŸ—‘ï¸ ${removedName} ÑƒĞ´Ğ°Ğ»ĞµĞ½`);
}
updateSubParticipant(mainIndex, subIndex, newName) {
// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ´ÑƒĞ±Ğ»Ğ¸: Ğ½Ğµ Ğ´Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ²Ñ‹Ğ±Ğ¾Ñ€ ÑƒĞ¶Ğµ Ğ·Ğ°Ğ½ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
const p = this.participants[mainIndex];
const usedNames = new Set([p.name]);
p.subParticipants.forEach((n, idx) => {
if (idx !== subIndex) usedNames.add(n);
});
// Ğ¢Ğ°ĞºĞ¶Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° ÑÑƒĞ±ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
this.participants.forEach((other, idx) => {
if (idx !== mainIndex) {
(other.subParticipants || []).forEach(n => usedNames.add(n));
}
});
if (usedNames.has(newName)) {
this.showToast(`âš ï¸ ${newName} ÑƒĞ¶Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ`);
this.renderParticipants();
return;
}
this.participants[mainIndex].subParticipants[subIndex] = newName;
this.saveData();
this.calculate();
}
// ===== ĞœĞµÑ‚Ğ¾Ğ´Ñ‹ Ğ´Ğ»Ñ Treffpunkt =====
updateTreffpunktName(index, newName) {
const coords = this.treffpunkt[newName] || { lat: null, lng: null };
this.participants[index].name = newName;
this.participants[index].lat = coords.lat;
this.participants[index].lng = coords.lng;
this.participants[index].timeManuallyEdited = false;
this.updateParticipantTimes();
this.saveData();
this.renderParticipants();
this.initSortable();
this.calculate();
}
openTreffpunktPersonModal(mainIndex) {
this.currentMainParticipantIndex = mainIndex;
const modal = document.getElementById('subModal');
const select = document.getElementById('subParticipantSelect');
const newSubNameRow = document.getElementById('newSubNameRow');
const newSubNameInput = document.getElementById('newSubName');
const mainParticipant = this.participants[mainIndex];

// Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ¿Ğ¾Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
newSubNameRow.classList.remove('visible');
newSubNameInput.value = '';

// Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ·Ğ°Ğ½ÑÑ‚Ñ‹Ğµ Ğ¸Ğ¼ĞµĞ½Ğ°
const usedNames = this.getAllUsedNames();

select.innerHTML = '<option value="">Person auswÃ¤hlen</option>';
Object.keys(this.nameToCoordinates)
.filter(name => !usedNames.has(name) && !this.treffpunkt[name])
.sort()
.forEach(name => {
const option = document.createElement('option');
option.value = name;
option.textContent = name;
select.appendChild(option);
});
// ĞĞ¿Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
const newOpt = document.createElement('option');
newOpt.value = 'add-new';
newOpt.textContent = 'â• Neue Personâ€¦';
select.appendChild(newOpt);

// ĞŸĞ¾ĞºĞ°Ğ·/ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ°
select.onchange = () => {
if (select.value === 'add-new') {
select.value = '';
document.getElementById('subModal').classList.remove('show');
this.openCoordsModal(null, false, false, false, false, false, true); // isAddingNewSubPerson
} else {
newSubNameRow.classList.remove('visible');
newSubNameInput.value = '';
}
};

modal.classList.add('show');
setTimeout(() => select.focus(), 100);
}
addTreffpunktPerson() {
const select = document.getElementById('subParticipantSelect');
const newSubNameInput = document.getElementById('newSubName');
let selectedName = select.value;

if (!selectedName) {
this.showToast('âš ï¸ Bitte Person auswÃ¤hlen');
return;
}

// ĞĞ¾Ğ²Ğ¾Ğµ Ğ¸Ğ¼Ñ Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ¾ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ
if (selectedName === 'add-new') {
const newName = newSubNameInput.value.trim();
if (!newName) {
this.showToast('âš ï¸ Bitte einen Namen eingeben');
newSubNameInput.focus();
return;
}
if (this.nameToCoordinates[newName]) {
this.showToast(`âš ï¸ "${newName}" existiert bereits`);
newSubNameInput.focus();
return;
}
this.nameToCoordinates[newName] = { lat: null, lng: null };
selectedName = newName;
}

const mainIndex = this.currentMainParticipantIndex;
if (!this.participants[mainIndex].treffpunktPersons) {
this.participants[mainIndex].treffpunktPersons = [];
}
this.participants[mainIndex].treffpunktPersons.push(selectedName);
document.getElementById('subModal').classList.remove('show');
this.saveData();
this.renderParticipants();
this.initSortable();
this.calculate();
this.showToast(`âœ… ${selectedName} â†’ ${this.participants[mainIndex].name}`);
}
removeTreffpunktPerson(mainIndex, personIdx) {
const removedName = this.participants[mainIndex].treffpunktPersons[personIdx];
this.participants[mainIndex].treffpunktPersons.splice(personIdx, 1);
this.saveData();
this.renderParticipants();
this.initSortable();
this.calculate();
this.showToast(`ğŸ—‘ï¸ ${removedName} entfernt`);
}
updateTreffpunktPerson(mainIndex, personIdx, newName) {
this.participants[mainIndex].treffpunktPersons[personIdx] = newName;
this.saveData();
this.calculate();
}
async calculateTravelTimeForParticipant(index) {
const p = this.participants[index];
if (!p) return;
if (!p.lat || !p.lng) {
  this.showToast('âš ï¸ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°');
  return;
}
// ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ÑƒÑ Ñ‚Ğ¾Ñ‡ĞºÑƒ
let prevLat, prevLng;
if (index === 0) {
  if (!this.startPointCoords.lat || !this.startPointCoords.lng) {
    this.showToast('âš ï¸ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ñ‚Ğ¾Ñ‡ĞºĞ¸');
    return;
  }
  prevLat = this.startPointCoords.lat;
  prevLng = this.startPointCoords.lng;
} else {
  const prev = this.participants[index - 1];
  if (!prev.lat || !prev.lng) {
    this.showToast('âš ï¸ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰ĞµĞ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°');
    return;
  }
  prevLat = prev.lat;
  prevLng = prev.lng;
}
try {
  this.showToast('ğŸ”„ Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ² Ğ¿ÑƒÑ‚Ğ¸...');
  const response = await fetch('/api/calculate-time', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      originLat: prevLat,
      originLng: prevLng,
      destLat: p.lat,
      destLng: p.lng,
      departureTime: 'now'
    })
  });
  if (!response.ok) {
    const errorData = await response.json();
    throw new Error(errorData.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº API');
  }
  const data = await response.json();
  if (data.success) {
    p.time = data.duration.minutes;
    p.routeCalculated = true;
    p.timeManuallyEdited = false;
    this.saveData();
    this.renderParticipants();
    this.calculate();
    this.showToast(`âœ… ${data.duration.minutes} Ğ¼Ğ¸Ğ½ (${data.distance.km} ĞºĞ¼)`);
  } else {
    throw new Error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ API');
  }
} catch (error) {
  this.showToast(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ${error.message}`);
}
}
async calculateTravelTimeToMachine() {
// ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° Ñ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ°Ğ¼Ğ¸
const validParticipants = this.participants.filter(p => p.name && p.lat && p.lng);
if (validParticipants.length === 0) {
this.showToast('âš ï¸ ĞĞµÑ‚ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ñ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ°Ğ¼Ğ¸');
return;
}
// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹
if (!this.machineStop.lat || !this.machineStop.lng) {
this.showToast('âš ï¸ Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹');
return;
}
const lastParticipant = validParticipants[validParticipants.length - 1];

// ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° Ñ‚Ñ€Ğ°Ñ„Ğ¸ĞºĞ°
let departureTime = 'now';
if (this.machineStop.arrivalTime) {
// Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ñ‚Ğ¸Ñ, Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ departure_time
const [hours, minutes] = this.machineStop.arrivalTime.split(':');
const arrivalDate = new Date();
arrivalDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
// ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Unix timestamp (ÑĞµĞºÑƒĞ½Ğ´Ñ‹)
departureTime = Math.floor(arrivalDate.getTime() / 1000).toString();
}

try {
this.showToast('ğŸ”„ Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ² Ğ¿ÑƒÑ‚Ğ¸...');

// Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Vercel serverless function
const response = await fetch('/api/calculate-time', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({
originLat: lastParticipant.lat,
originLng: lastParticipant.lng,
destLat: this.machineStop.lat,
destLng: this.machineStop.lng,
departureTime: departureTime
})
});

if (!response.ok) {
const errorData = await response.json();
throw new Error(errorData.message || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğº API');
}

const data = await response.json();

if (data.success) {
// ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹
this.machineStop.time = data.duration.minutes;
this.machineStop.autoCalculated = true;
this.saveData();
this.renderParticipants();
this.calculate();

const timeInfo = this.machineStop.arrivalTime ? ` Ğº ${this.machineStop.arrivalTime}` : ' ÑĞµĞ¹Ñ‡Ğ°Ñ';
const trafficInfo = data.hasTraffic ? ' (Ñ ÑƒÑ‡ĞµÑ‚Ğ¾Ğ¼ Ñ‚Ñ€Ğ°Ñ„Ğ¸ĞºĞ°)' : '';
this.showToast(`âœ… ${data.duration.minutes} Ğ¼Ğ¸Ğ½ (${data.distance.km} ĞºĞ¼)${timeInfo}${trafficInfo}`);
console.log(`Ğ’Ñ€ĞµĞ¼Ñ Ğ² Ğ¿ÑƒÑ‚Ğ¸: ${data.duration.minutes} Ğ¼Ğ¸Ğ½, Ğ Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ: ${data.distance.km} ĞºĞ¼, Ğ’Ñ€ĞµĞ¼Ñ: ${timeInfo}${trafficInfo}`);
} else {
throw new Error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ API');
}
} catch (error) {
console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ°:', error);
this.showToast(`âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ${error.message}`);
}
}
updateMachineName(value) {
this.machineStop.name = value.trim() || 'an der Maschine';
this.saveData();
this.calculate();
}
updateMachineTime(value) {
const time = parseInt(value) || 20;
this.machineStop.time = Math.max(1, Math.min(720, time));
this.machineStop.autoCalculated = false;  // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ¿Ñ€Ğ¸ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸
this.saveData();
this.calculate();
}
clearArrivalTime() {
this.machineStop.arrivalTime = "";
this.saveData();
this.elements.output.innerHTML = '';
this.renderParticipants();
}
startTimeEdit() {
const container = document.querySelector('.machine .right-section');
const existingInput = container.querySelector('input[type="time"]');
if (existingInput) existingInput.remove();
const input = document.createElement('input');
input.type = 'time';
input.style.width = '100px';
input.style.padding = 'var(--small-spacing)';
input.style.border = '1px solid #ddd';
input.style.borderRadius = '4px';
input.style.fontSize = '1em';
input.value = this.machineStop.arrivalTime || '';
const timeControl = container.querySelector('.time-icon') || container.querySelector('.arrival-time');
container.insertBefore(input, timeControl);
timeControl.style.display = 'none';
const saveTime = () => {
this.machineStop.arrivalTime = input.value;
container.removeChild(input);
timeControl.style.display = 'flex';
this.renderParticipants();
this.initSortable();
this.calculate();
input.removeEventListener('change', saveTime);
input.removeEventListener('blur', saveTime);
};
input.addEventListener('change', saveTime);
input.addEventListener('blur', () => setTimeout(saveTime, 50));
input.focus();
try { input.showPicker(); } catch { }
}
initSortable() {
if (this.sortable) this.sortable.destroy();
this.sortable = new Sortable(this.elements.participantsContainer, {
handle: '.material-symbols-outlined',
animation: 150,
onEnd: evt => {
if (evt.oldIndex !== evt.newIndex) {
const [moved] = this.participants.splice(evt.oldIndex, 1);
this.participants.splice(evt.newIndex, 0, moved);
this.updateParticipantTimes();
this.saveData();
this.renderParticipants();
this.calculate();
}
}
});
}
showToast(message) {
this.elements.toast.textContent = message;
this.elements.toast.classList.add('show');
setTimeout(() => this.elements.toast.classList.remove('show'), 3000);
}
formatTime(date) {
if (this.useSuperscriptTime) {
const hours = date.getHours().toString().padStart(2, '0');
const minutes = date.getMinutes().toString().padStart(2, '0');
const superscriptDigits = ['â°', 'Â¹', 'Â²', 'Â³', 'â´', 'âµ', 'â¶', 'â·', 'â¸', 'â¹'];
const superscriptMinutes = minutes.split('').map(d => superscriptDigits[parseInt(d)]).join('');
return `${hours}${superscriptMinutes}`;
}
return date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
}
calculate(){
if(!this.machineStop.arrivalTime){this.elements.output.innerHTML='';return}
let out=`${this.greeting},
`;
const valid=this.participants.filter(p=>p.name);
const total=valid.reduce((s,p)=>s+p.time,0)+this.machineStop.time;
// 1. Ğ’Ğ«Ğ§Ğ˜Ğ¡Ğ›Ğ¯Ğ•Ğœ Ğ’Ğ Ğ•ĞœĞ¯ Ğ¡Ğ¢ĞĞ Ğ¢Ğ
const startTime=new Date(`2025-07-25T${this.machineStop.arrivalTime}:00`);
startTime.setMinutes(startTime.getMinutes()-total);
// 2. Ğ¤ĞĞ ĞœĞ˜Ğ Ğ£Ğ•Ğœ Ğ’Ğ«Ğ’ĞĞ”
out+=this.useUhrBei
? `um ${this.formatTime(startTime)} Uhr geht's los
`
: `${this.formatTime(startTime)}  geht's los
`;
let current=new Date(startTime);
valid.forEach(p=>{
current.setMinutes(current.getMinutes()+p.time);
let line = '';
if (p.isTreffpunkt) {
// Treffpunkt: Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ "12:00 RenÃ© (Olga-Park)" Ğ¸Ğ»Ğ¸ "12:00 RenÃ©, Vasyl und Alex (Olga-Park)"
const persons = (p.treffpunktPersons || []).filter(n => n);
let personsStr = '';
if (persons.length === 0) {
personsStr = p.name; // Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ Ğ½Ğ¸ĞºĞ¾Ğ³Ğ¾ Ğ½Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ¸
} else if (persons.length === 1) {
personsStr = `${persons[0]} (${p.name})`;
} else if (persons.length === 2) {
personsStr = `${persons[0]} und ${persons[1]} (${p.name})`;
} else {
personsStr = persons.slice(0, -1).join(', ') + ' und ' + persons[persons.length - 1] + ` (${p.name})`;
}
line = this.useUhrBei
? `um ${this.formatTime(current)} Uhr bei ${personsStr}
`
: `${this.formatTime(current)}  ${personsStr}
`;
} else {
// ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº (Ğ¾Ñ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´)
let names = p.name;
if (p.subParticipants && p.subParticipants.length > 0) {
const subs = p.subParticipants.filter(n => n);
if (subs.length > 0) {
const all = [p.name, ...subs];
if (all.length === 2) {
names = `${all[0]} und ${all[1]}`;
} else {
names = all.slice(0, -1).join(', ') + ' und ' + all[all.length - 1];
}
}
}
line = this.useUhrBei
? `um ${this.formatTime(current)} Uhr bei ${names}
`
: `${this.formatTime(current)}  ${names}
`;
}
out += line;
});
// Ğ’Ñ€ĞµĞ¼Ñ Ğ¿Ñ€Ğ¸Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğº Ğ¼Ğ°ÑˆĞ¸Ğ½Ğµ
const machineTime=new Date(`2025-07-25T${this.machineStop.arrivalTime}:00`);
out+=this.useUhrBei
? `um ${this.formatTime(machineTime)} Uhr ${this.machineStop.name}
`
: `${this.formatTime(machineTime)}  ${this.machineStop.name}
`;
this.elements.output.innerHTML=out;
}

// âœ… Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ â€” Ğ¡ Ğ£Ğ§ĞĞ¢ĞĞœ Ğ¢Ğ’ĞĞ•Ğ“Ğ Ğ£Ğ¢ĞĞ§ĞĞ•ĞĞ˜Ğ¯
openGoogleMaps(returnTrip = false) {
  const validParticipants = this.participants.filter(p => p.name && p.lat && p.lng);

  // ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚ Ñ‚ÑƒĞ´Ğ° Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ ĞºĞ¾Ğ½ĞµÑ‡Ğ½ÑƒÑ Ñ‚Ğ¾Ñ‡ĞºÑƒ (Ğ¼Ğ°ÑˆĞ¸Ğ½Ñƒ) Ğ¸Ğ»Ğ¸ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°
  if (!returnTrip) {
    const hasDest = this.machineStop.lat && this.machineStop.lng;
    if (validParticipants.length === 0 && !hasDest) {
      this.showToast("Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ñ‹ ĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾Ğ¹ Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ¸Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ².");
      return;
    }
  }

  if (!navigator.geolocation) {
    this.showToast("Ğ“ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const currentLat = position.coords.latitude;
      const currentLng = position.coords.longitude;
      const origin = `${currentLat},${currentLng}`;

      let waypoints = [];
      let destination;

      if (!returnTrip) {
        // â¤ ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚ Ğ¢Ğ£Ğ”Ğ: Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ â†’ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ â†’ Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ°
        waypoints = validParticipants.map(p => `${p.lat},${p.lng}`);
        if (this.machineStop.lat && this.machineStop.lng) {
          destination = `${this.machineStop.lat},${this.machineStop.lng}`;
        } else {
          // ĞĞµÑ‚ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚ Ğ¼Ğ°ÑˆĞ¸Ğ½Ñ‹ â€” ĞºĞ¾Ğ½ĞµÑ† Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ° = Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº
          destination = waypoints.pop();
        }
      } else {
        // â—€ ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚ ĞĞ‘Ğ ĞĞ¢ĞĞ: Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ â†’ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ (Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº) â†’ Ğ´Ğ¾Ğ¼ Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ
        if (!this.startPointCoords.lat || !this.startPointCoords.lng) {
          this.showToast("Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½ÑƒÑ Ñ‚Ğ¾Ñ‡ĞºÑƒ (Ğ´Ğ¾Ğ¼ Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ) Ğ´Ğ»Ñ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ° Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾.");
          return;
        }
        if (validParticipants.length === 0) {
          this.showToast("Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° Ñ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ°Ğ¼Ğ¸ Ğ´Ğ»Ñ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ° Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾.");
          return;
        }
        waypoints = [...validParticipants].reverse().map(p => `${p.lat},${p.lng}`);
        destination = `${this.startPointCoords.lat},${this.startPointCoords.lng}`;
      }

      let url = 'https://www.google.com/maps/dir/?api=1';
      url += `&origin=${encodeURIComponent(origin)}`;
      url += `&destination=${encodeURIComponent(destination)}`;
      if (waypoints.length > 0) {
        url += `&waypoints=${encodeURIComponent(waypoints.join('|'))}`;
      }
      url += '&travelmode=driving';

      window.open(url, '_blank');
    },
    (error) => {
      console.error("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸:", error);
      this.showToast("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ğ²Ğ°ÑˆĞµ Ğ¼ĞµÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ. Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸.");
    },
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
  );
}

// âŒ Ğ£Ğ”ĞĞ›Ğ•ĞĞ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ openGoogleMapsInNewTab

copyResult() {
const text = this.elements.output.textContent.trim();
if (!text) {
this.showToast("ĞĞµÑ‡ĞµĞ³Ğ¾ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ â€” ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ğ°Ğ¹Ñ‚Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚.");
return;
}
navigator.clipboard.writeText(text)
.then(() => this.showToast("ğŸ“‹ Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾"))
.catch(() => this.showToast("âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ â€” Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚Ğµ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ±ÑƒÑ„ĞµÑ€Ñƒ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ°."));
}
removeParticipant(index) {
this.participants.splice(index, 1);
this.updateParticipantTimes();
this.saveData();
this.renderParticipants();
this.initSortable();
this.calculate();
}
}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {

// â”€â”€ ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = new FahrzeitRechner();
window._appInstance = app;
app.loadStations();
// ---------- Ñ‚ĞµĞ¼Ğ° ----------
const switcher = document.getElementById('themeSwitch');
if (!switcher) return;
// Ğ£Ğ¡Ğ¢ĞĞĞĞ’Ğ›Ğ˜Ğ’ĞĞ•Ğœ Ğ¦Ğ’Ğ•Ğ¢ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡-Ğ‘ĞĞ Ğ Ğ¡Ğ ĞĞ—Ğ£
const meta = document.getElementById('theme-meta');
meta.content = (localStorage.theme === 'dark') ? '#121212' : '#f0f0f0';
// Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½ÑƒÑ Ñ‚ĞµĞ¼Ñƒ
if (localStorage.theme === 'dark') document.body.classList.add('dark');
switcher.checked = localStorage.theme === 'dark';
// Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾ ĞºĞ»Ğ¸ĞºÑƒ
switcher.addEventListener('change', e => {
document.body.classList.toggle('dark', e.target.checked);
localStorage.theme = e.target.checked ? 'dark' : 'light';
meta.content = e.target.checked ? '#121212' : '#f0f0f0';
});
});
</script>
<!-- Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ bcrypt -->
<script src="
https://cdn.jsdelivr.net/npm/bcryptjs@3.0.2/umd/index.min.js
"></script>
<script>
// Ñ…ÑÑˆ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ '266214' (10 Ñ€Ğ°ÑƒĞ½Ğ´Ğ¾Ğ²)
const GOD_HASH = '$2a$12$O3Syhnm4rRn55bdKSmkZ5e9ptITFc23gshbj2NugI2N/khhcZlwOm';
document.addEventListener('DOMContentLoaded', () => {
const link = document.getElementById('godL');
const modal = document.getElementById('godModal');
const input = document.getElementById('godPasswordInput');
const submitBtn = document.getElementById('godSubmitBtn');
const cancelBtn = document.getElementById('godCancelBtn');

if (!link) { console.error('godL Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½'); return; }

// Ğ•ÑĞ»Ğ¸ ÑƒĞ¶Ğµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ Ğ² ÑÑ‚Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸ â€” ÑÑ€Ğ°Ğ·Ñƒ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ±ĞµĞ· Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºĞ¸
link.addEventListener('click', (e) => {
e.preventDefault();
if (sessionStorage.getItem('godAuth') === '1') {
  window.location.href = link.href;
  return;
}
modal.classList.add('show');
input.value = '';
input.classList.remove('error');
submitBtn.innerHTML = 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸';
submitBtn.disabled = false;
});

// ĞŸÑ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ°Ğ´ (bfcache) â€” Ğ·Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ ĞµÑĞ»Ğ¸ Ğ²Ğ´Ñ€ÑƒĞ³ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ°
window.addEventListener('pageshow', () => {
  modal.classList.remove('show');
});

// Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºĞ½Ğ°
const closeModal = () => {
modal.classList.remove('show');
input.value = '';
input.classList.remove('error');
};

// ĞÑ‚Ğ¼ĞµĞ½Ğ°
cancelBtn.addEventListener('click', closeModal);

// Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ Ğ²Ğ½Ğµ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºĞ½Ğ°
modal.addEventListener('click', (e) => {
if (e.target === modal) closeModal();
});

// Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ğ¾ Escape
document.addEventListener('keydown', (e) => {
if (e.key === 'Escape' && modal.classList.contains('show')) {
closeModal();
}
});

// ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
const checkPassword = async () => {
const pwd = input.value.trim();
if (!pwd) {
input.classList.add('error');
return;
}

// ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ loader
submitBtn.innerHTML = 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°...<span class="god-loader"></span>';
submitBtn.disabled = true;

try {
const ok = await bcrypt.compare(pwd, GOD_HASH);
if (ok) {
submitBtn.innerHTML = 'âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾!';
sessionStorage.setItem('godAuth', '1');
setTimeout(() => {
window.location.href = link.href;
}, 500);
} else {
submitBtn.innerHTML = 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸';
submitBtn.disabled = false;
input.classList.add('error');
input.value = '';
input.focus();
// ĞĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ°Ñ Ğ²Ğ¸Ğ±Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ…
if (navigator.vibrate) navigator.vibrate(200);
}
} catch (error) {
console.error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ:', error);
submitBtn.innerHTML = 'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸';
submitBtn.disabled = false;
}
};

// ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ’Ğ¾Ğ¹Ñ‚Ğ¸"
submitBtn.addEventListener('click', checkPassword);

// Enter Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸
input.addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
checkPassword();
}
});

// Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ Ğ¿Ñ€Ğ¸ Ğ²Ğ²Ğ¾Ğ´Ğµ
input.addEventListener('input', () => {
input.classList.remove('error');
});
});
</script>
<!-- Ğ¸ĞºĞ¾Ğ½ĞºĞ° ĞºĞ¾Ğ½ÑĞ¾Ğ»Ğ¸ -->
<button id="btnConsole"
title="ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ/ÑĞºÑ€Ñ‹Ñ‚ÑŒ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ"
style="position:fixed; left:3px; bottom:3px; z-index:9999;
width:24px; height:24px;          /* Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ */
margin:0; padding:0; border:none; background:none;
color: var(--text);
display:flex; align-items:center; justify-content:center;
cursor:pointer;">
<svg width="32" height="32" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
<path d="M5.64645 9.14645C5.84171 8.95118 6.15829 8.95118 6.35355 9.14645L8.35355 11.1464C8.44732 11.2402 8.5 11.3674 8.5 11.5C8.5 11.6326 8.44732 11.7598 8.35355 11.8536L6.35355 13.8536C6.15829 14.0488 5.84171 14.0488 5.64645 13.8536C5.45118 13.6583 5.45118 13.3417 5.64645 13.1464L7.29289 11.5L5.64645 9.85355C5.45118 9.65829 5.45118 9.34171 5.64645 9.14645ZM14.5 13H9.5C9.22386 13 9 13.2239 9 13.5C9 13.7761 9.22386 14 9.5 14H14.5C14.7761 14 15 13.7761 15 13.5C15 13.2239 14.7761 13 14.5 13ZM2.99609 5.5C2.99609 4.11929 4.11538 3 5.49609 3H14.4961C15.8768 3 16.9961 4.11929 16.9961 5.5V6H16.999V7H16.9961V14.5C16.9961 15.8807 15.8768 17 14.4961 17H5.49609C4.11538 17 2.99609 15.8807 2.99609 14.5V5.5ZM15.9961 6V5.5C15.9961 4.67157 15.3245 4 14.4961 4H5.49609C4.66767 4 3.99609 4.67157 3.99609 5.5V6H15.9961ZM3.99609 7V14.5C3.99609 15.3284 4.66767 16 5.49609 16H14.4961C15.3245 16 15.9961 15.3284 15.9961 14.5V7H3.99609Z"/>
</svg>
</button>
<!-- ÑĞ°Ğ¼Ğ° ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ (Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾ ÑĞºÑ€Ñ‹Ñ‚Ğ°) -->
<div id="mobileConsole" style="
display:none;
position:fixed; inset:auto 0 0 0; height:120px;
background:#000; color:#0f0; font:11px/1.3 monospace;
overflow:auto; padding:4px; z-index:9998;">
<div>=== ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ ===</div>
</div>
<script>
/* ---------- Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°Ñ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ ---------- */
const con = document.getElementById('mobileConsole');
const btn = document.getElementById('btnConsole');
// Ğ¿ĞµÑ€ĞµÑ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ console.log
const origLog = console.log;
console.log = function (...args) {
origLog(...args);                       // Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ¾Ğ±Ñ‹Ñ‡Ğ½ÑƒÑ ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ
const line = args.map(a => typeof a === 'object' ? JSON.stringify(a) : a).join(' ');
con.insertAdjacentHTML('beforeend', '<div>' + line + '</div>');
con.scrollTop = con.scrollHeight;
};
// Ğ¿Ğ¾ĞºĞ°Ğ·/ÑĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞµ
btn.addEventListener('click', () => {
con.style.display = con.style.display === 'none' ? 'block' : 'none';
});
/* Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ */
console.log('mobile console ready');

</body>
</html>
